<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>IlTuoCaveau - Registro Movimenti</title>
<style>
  :root {
    --bg:#f0f4f8;--surface:white;--surface2:#f9f9f9;--border:#eee;
    --text:#333;--text2:#555;--text3:#777;--text4:#aaa;
    --shadow:rgba(0,0,0,.08);--shadow2:rgba(0,0,0,.12);
    --input-border:#ccc;--input-bg:white;--hover:#f0f4f8;
    --tag-bg:#e8f0fe;--row-hover:#f8f9ff;--edit-row:#fffde7;
    --insert-bg:#eef4ff;--insert-border:#1a73e8;
  }
  body.dark {
    --bg:#1a1d23;--surface:#252932;--surface2:#1e2128;--border:#3a3f4b;
    --text:#e8eaf0;--text2:#b0b8c8;--text3:#7a8499;--text4:#4a5268;
    --shadow:rgba(0,0,0,.3);--shadow2:rgba(0,0,0,.5);
    --input-border:#3a3f4b;--input-bg:#2d3140;--hover:#2d3140;
    --tag-bg:#1e3a6e;--row-hover:#2d3140;--edit-row:#2d2a1e;
    --insert-bg:#1e2a42;--insert-border:#4a90d9;
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}
  body{background:var(--bg);padding:20px;color:var(--text);transition:background .3s,color .3s;}

  /* LOGIN */
  .login-wrapper{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
  .login-box{background:var(--surface);border-radius:16px;padding:40px;width:100%;max-width:400px;box-shadow:0 8px 32px var(--shadow2);}
  .login-logo{text-align:center;margin-bottom:32px;}
  .login-title{font-size:24px;font-weight:900;letter-spacing:.5px;margin-bottom:8px;}
  .login-subtitle{font-size:11px;color:var(--text3);letter-spacing:1.5px;font-style:italic;}
  .login-form{display:flex;flex-direction:column;gap:16px;}
  .login-input{padding:12px 16px;border:1px solid var(--input-border);border-radius:8px;font-size:14px;background:var(--input-bg);color:var(--text);transition:border .2s;}
  .login-input:focus{outline:none;border-color:#1a73e8;}
  .login-btn{padding:14px;background:#1a73e8;color:white;border:none;border-radius:8px;cursor:pointer;font-size:15px;font-weight:bold;transition:background .2s;}
  .login-btn:hover{background:#1558b0;}
  .login-btn:disabled{background:#ccc;cursor:not-allowed;}
  .login-error{background:#fce8e6;color:#ea4335;padding:12px;border-radius:8px;font-size:13px;text-align:center;}
  #app{display:none;}
  #app.loaded{display:block;}

  /* LAYOUT */
  .app-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;}
  .logo-wrap{display:flex;align-items:center;gap:8px;}
  .header-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .user-info{background:var(--surface);border:1px solid var(--input-border);border-radius:8px;padding:6px 12px;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px;}
  .btn-logout{background:#ea4335;color:white;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-size:12px;font-weight:bold;}
  .btn-logout:hover{background:#c5221f;}
  .btn-settings{background:var(--surface);border:1px solid var(--input-border);color:var(--text2);border-radius:8px;padding:7px 14px;cursor:pointer;font-size:13px;display:flex;align-items:center;gap:6px;transition:all .2s;}
  .btn-settings:hover{background:var(--hover);}

  /* SETTINGS */
  .settings-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;align-items:center;justify-content:center;}
  .settings-overlay.open{display:flex;}
  .settings-panel{background:var(--surface);border-radius:14px;padding:24px;width:340px;box-shadow:0 8px 32px var(--shadow2);}
  .settings-panel h3{font-size:16px;color:var(--text);margin-bottom:18px;}
  .settings-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
  .settings-row:last-child{border-bottom:none;padding-bottom:0;}
  .settings-row label{font-size:14px;color:var(--text2);}
  .toggle-wrap{display:flex;align-items:center;gap:10px;}
  .toggle-label{font-size:12px;color:var(--text3);}
  .toggle{position:relative;width:44px;height:24px;}
  .toggle input{opacity:0;width:0;height:0;}
  .toggle-slider{position:absolute;inset:0;background:#ccc;border-radius:24px;cursor:pointer;transition:.3s;}
  .toggle-slider:before{content:'';position:absolute;width:18px;height:18px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s;}
  .toggle input:checked+.toggle-slider{background:#1a73e8;}
  .toggle input:checked+.toggle-slider:before{transform:translateX(20px);}
  .btn-close-settings{width:100%;margin-top:16px;padding:10px;background:#1a73e8;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;}
  .settings-select{padding:6px 10px;border:1px solid var(--input-border);border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);}

  /* NAV */
  nav{display:flex;gap:4px;margin-bottom:20px;background:var(--surface);border-radius:12px;padding:6px;box-shadow:0 2px 8px var(--shadow);flex-wrap:wrap;}
  .nav-btn{flex:1;min-width:80px;padding:10px;border:none;background:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:bold;color:var(--text2);transition:all .15s;}
  .nav-btn:hover{background:var(--hover);}
  .nav-btn.active{background:#1a73e8;color:white;}
  .page{display:none;} .page.active{display:block;}
  h2{text-align:center;color:#1a73e8;margin-bottom:20px;font-size:20px;}
  h3{font-size:14px;color:var(--text2);margin-bottom:10px;}

  /* CARDS */
  .summary{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;}
  .card{flex:1;min-width:130px;padding:12px 16px;border-radius:10px;color:white;text-align:center;}
  .card.in{background:#34a853;} .card.out{background:#ea4335;}
  .card.saldo-pos{background:#1a73e8;} .card.saldo-neg{background:#e65100;} .card.neutral{background:#607d8b;}
  .card label{font-size:11px;opacity:.9;display:block;margin-bottom:3px;}
  .card span{font-size:16px;font-weight:bold;}
  .filter-note{font-size:10px;color:#ffe082;font-style:italic;}

  /* ENTITY BANNER */
  .entity-banner{background:#1a73e8;color:white;border-radius:10px;padding:10px 16px;margin-bottom:10px;display:none;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
  .entity-banner.active{display:flex;}
  .entity-banner span{font-size:13px;font-weight:bold;}
  .entity-banner button{background:rgba(255,255,255,.25);border:none;color:white;border-radius:6px;padding:4px 12px;cursor:pointer;font-size:12px;}

  /* FILTERS */
  .filter-toggle-bar{display:flex;align-items:center;justify-content:space-between;background:var(--surface);border-radius:10px;padding:10px 16px;margin-bottom:8px;box-shadow:0 2px 8px var(--shadow);cursor:pointer;user-select:none;}
  .filter-toggle-bar.open{border-radius:10px 10px 0 0;}
  .filter-toggle-bar:hover{background:var(--hover);}
  .filter-toggle-left{display:flex;align-items:center;gap:10px;font-size:13px;font-weight:bold;color:var(--text2);}
  .filter-toggle-right{display:flex;align-items:center;gap:8px;}
  .filter-active-badge{background:#1a73e8;color:white;border-radius:12px;padding:2px 10px;font-size:11px;font-weight:bold;display:none;}
  .filter-active-badge.show{display:inline-block;}
  .filter-chevron{font-size:12px;color:var(--text3);transition:transform .25s;}
  .filter-chevron.open{transform:rotate(180deg);}
  .filter-panel{display:none;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;padding:14px 16px;margin-bottom:12px;box-shadow:0 4px 8px var(--shadow);}
  .filter-panel.open{display:block;}
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
  .filter-row:last-child{margin-bottom:0;}
  .filter-label{font-size:12px;color:var(--text2);font-weight:bold;min-width:65px;}
  .multi-select-wrap{position:relative;flex:1;min-width:120px;}
  .mst{width:100%;padding:6px 26px 6px 9px;border:1px solid var(--input-border);border-radius:6px;background:var(--input-bg);color:var(--text);font-size:12px;cursor:pointer;text-align:left;user-select:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;position:relative;}
  .mst::after{content:'‚ñæ';position:absolute;right:7px;top:50%;transform:translateY(-50%);color:var(--text3);}
  .mst.af-c1{border-color:#9c27b0;color:#9c27b0;font-weight:bold;}
  .mst.af-c2{border-color:#e67e22;color:#e67e22;font-weight:bold;}
  .mst.af-c3{border-color:#16a085;color:#16a085;font-weight:bold;}
  .dropdown-panel{display:none;position:absolute;top:calc(100% + 4px);left:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 16px var(--shadow2);z-index:100;min-width:180px;max-height:220px;overflow-y:auto;padding:6px 0;}
  .dropdown-panel.open{display:block;}
  .dropdown-item{display:flex;align-items:center;gap:8px;padding:6px 13px;cursor:pointer;font-size:12px;color:var(--text);}
  .dropdown-item:hover{background:var(--hover);}
  .dropdown-item input[type="checkbox"]{cursor:pointer;width:14px;height:14px;accent-color:#1a73e8;}
  .di-c1 input{accent-color:#9c27b0;} .di-c2 input{accent-color:#e67e22;} .di-c3 input{accent-color:#16a085;}
  .dropdown-empty{padding:9px 13px;color:var(--text4);font-size:12px;font-style:italic;}
  .date-range{display:flex;gap:8px;align-items:center;flex-wrap:wrap;flex:2;}
  .date-range input[type="date"]{padding:6px 9px;border:1px solid var(--input-border);border-radius:6px;font-size:12px;flex:1;min-width:115px;background:var(--input-bg);color:var(--text);}
  .date-range span{font-size:12px;color:var(--text3);}
  .btn-sm{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;font-size:12px;}
  .btn-sm.red{background:#fce8e6;color:#ea4335;}
  .btn-sm.grey{background:var(--hover);color:var(--text3);}
  .entity-filter-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap;flex:1;}
  .entity-select,.tipo-select,.val-select{padding:6px 10px;border:1px solid var(--input-border);border-radius:6px;font-size:12px;flex:1;min-width:120px;background:var(--input-bg);color:var(--text);}
  .entity-select.active-sel{border-color:#1a73e8;color:#1a73e8;font-weight:bold;}
  .tipo-select.active-sel{border-color:#8e44ad;color:#8e44ad;font-weight:bold;}
  .val-select.active-sel{border-color:#e67e22;color:#e67e22;font-weight:bold;}
  .filter-reset-row{display:flex;justify-content:flex-end;margin-top:4px;}

  /* INSERT BOX */
  .insert-box{background:var(--insert-bg);border:2px solid var(--insert-border);border-radius:12px;padding:16px 18px;margin-bottom:14px;box-shadow:0 2px 10px var(--shadow);}
  .insert-box-title{font-size:13px;font-weight:bold;color:var(--insert-border);margin-bottom:12px;display:flex;align-items:center;gap:6px;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .controls input,.controls select{padding:7px 9px;border:1px solid var(--input-border);border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);}
  .controls input[type="date"]{flex:1;min-width:115px;}
  .controls input[type="text"]{flex:2;min-width:120px;}
  .controls input[type="number"]{flex:1;min-width:80px;}
  .controls select{flex:1;min-width:100px;}
  .btn-add{padding:8px 16px;background:#1a73e8;color:white;border:none;border-radius:6px;cursor:pointer;font-size:13px;font-weight:bold;}
  .btn-add:hover{background:#1558b0;}
  .arrow-label{font-size:18px;color:#1a73e8;font-weight:bold;padding:0 2px;}

  /* FX ROW */
  .fx-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px;padding:8px 12px;background:rgba(230,126,34,.1);border:1px solid #e67e22;border-radius:8px;}
  .fx-label{font-size:12px;color:#e67e22;font-weight:bold;min-width:60px;}
  .fx-badge{background:#e67e22;color:white;border-radius:8px;padding:2px 8px;font-size:11px;font-weight:bold;white-space:nowrap;}
  .fx-rate-info{font-size:11px;color:var(--text3);font-style:italic;}
  .fx-loading{font-size:11px;color:#1a73e8;font-style:italic;}

  /* CURRENCY BADGES */
  .cur-eur{background:#e8f0fe;color:#1a73e8;border-radius:8px;padding:1px 6px;font-size:10px;font-weight:bold;}
  .cur-gbp{background:#f3e5f5;color:#8e44ad;border-radius:8px;padding:1px 6px;font-size:10px;font-weight:bold;}
  .cur-aed{background:#fff3e0;color:#e67e22;border-radius:8px;padding:1px 6px;font-size:10px;font-weight:bold;}
  .cur-other{background:#e0f5f1;color:#16a085;border-radius:8px;padding:1px 6px;font-size:10px;font-weight:bold;}
  body.dark .cur-eur{background:#1e3a6e;color:#7ec0f5;}
  body.dark .cur-gbp{background:#3a1a4a;color:#ce93d8;}
  body.dark .cur-aed{background:#3a2a10;color:#ffb74d;}
  body.dark .cur-other{background:#0a2a25;color:#4db6ac;}

  /* TABLE */
  table{width:100%;border-collapse:collapse;background:var(--surface);border-radius:10px;overflow:hidden;box-shadow:0 2px 8px var(--shadow);}
  thead{background:#1a73e8;color:white;}
  th{padding:9px 8px;text-align:left;font-size:11px;white-space:nowrap;}
  th.sortable{cursor:pointer;user-select:none;}
  th.sortable:hover{background:rgba(255,255,255,.15);}
  td{padding:7px 8px;font-size:11px;border-bottom:1px solid var(--border);color:var(--text);}
  tr:hover td{background:var(--row-hover);}
  tr.editing td{background:var(--edit-row)!important;}
  tr.exchange-row td{background:rgba(230,126,34,.05);}
  body.dark tr.exchange-row td{background:rgba(230,126,34,.08);}
  .badge-name{border-radius:10px;padding:2px 8px;font-size:10px;font-weight:bold;cursor:pointer;transition:opacity .15s;white-space:nowrap;}
  .badge-name:hover{opacity:.75;}
  .badge-from{background:#fce8e6;color:#c0392b;}
  .badge-to{background:#e6f4ea;color:#1e8449;}
  body.dark .badge-from{background:#4a1a1a;color:#ff6b6b;}
  body.dark .badge-to{background:#1a3a2a;color:#6bcf8a;}
  .tipo-tag{background:#f3e5f5;color:#8e44ad;border-radius:8px;padding:1px 6px;font-size:9px;font-weight:bold;display:inline-block;margin-left:2px;vertical-align:middle;}
  body.dark .tipo-tag{background:#3a1a4a;color:#ce93d8;}
  .c1-badge{background:#f3e5f5;color:#9c27b0;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:bold;}
  .c2-badge{background:#fff3e0;color:#e67e22;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:bold;}
  .c3-badge{background:#e0f5f1;color:#16a085;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:bold;}
  body.dark .c1-badge{background:#3a1a4a;color:#ce93d8;}
  body.dark .c2-badge{background:#3a2a10;color:#ffb74d;}
  body.dark .c3-badge{background:#0a2a25;color:#4db6ac;}
  .amount-pos{color:#34a853;font-weight:bold;} .amount-neg{color:#ea4335;font-weight:bold;} .amount-neu{color:var(--text2);font-weight:bold;}
  .fx-tag{background:#e67e22;color:white;border-radius:6px;padding:1px 5px;font-size:9px;font-weight:bold;display:inline-block;margin-left:2px;}
  .empty{text-align:center;color:var(--text4);padding:30px;font-style:italic;}
  .row-actions{display:flex;gap:3px;}
  .btn-edit,.btn-del,.btn-save,.btn-cancel{border:none;border-radius:5px;cursor:pointer;font-size:11px;padding:3px 6px;}
  .btn-edit{background:#e8f0fe;color:#1a73e8;} .btn-del{background:#fce8e6;color:#ea4335;}
  .btn-save{background:#e6f4ea;color:#34a853;font-weight:bold;} .btn-cancel{background:var(--hover);color:var(--text3);}
  .edit-input{width:100%;padding:3px 5px;border:1px solid #1a73e8;border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text);}
  .edit-select{padding:3px 5px;border:1px solid #1a73e8;border-radius:4px;font-size:11px;width:100%;background:var(--input-bg);color:var(--text);}
  .btn-action{padding:8px 16px;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;}
  .btn-action.purple{background:#8e44ad;} .btn-action.purple:hover{background:#7d3c98;}

  /* ARCHIVIO NOMI */
  .archivio-box{background:var(--surface);border-radius:10px;padding:18px;box-shadow:0 2px 8px var(--shadow);margin-bottom:20px;}
  .nomi-table{width:100%;border-collapse:collapse;margin-bottom:14px;}
  .nomi-table th{text-align:left;padding:7px 10px;font-size:12px;color:white;border-bottom:2px solid var(--border);font-weight:bold;}
  .nomi-table td{padding:7px 10px;font-size:13px;border-bottom:1px solid var(--border);color:var(--text);vertical-align:middle;}
  .nomi-table tr:hover td{background:var(--row-hover);}
  .nome-tipo-badge{background:#f3e5f5;color:#8e44ad;border-radius:8px;padding:2px 8px;font-size:11px;font-weight:bold;display:inline-block;}
  body.dark .nome-tipo-badge{background:#3a1a4a;color:#ce93d8;}
  .nome-tipo-empty{color:var(--text4);font-size:11px;font-style:italic;}
  .btn-nome-del{background:#fce8e6;color:#ea4335;border:none;border-radius:5px;cursor:pointer;font-size:11px;padding:3px 8px;}
  .btn-nome-edit{background:#e8f0fe;color:#1a73e8;border:none;border-radius:5px;cursor:pointer;font-size:11px;padding:3px 8px;margin-right:3px;}
  .nome-edit-input{padding:4px 8px;border:1px solid #1a73e8;border-radius:5px;font-size:12px;background:var(--input-bg);color:var(--text);width:110px;}
  .nome-edit-tipo{padding:4px 8px;border:1px solid #8e44ad;border-radius:5px;font-size:12px;background:var(--input-bg);color:var(--text);min-width:90px;}
  .nome-edit-val{padding:4px 8px;border:1px solid #e67e22;border-radius:5px;font-size:12px;background:var(--input-bg);color:var(--text);min-width:70px;}
  .btn-nome-save{background:#e6f4ea;color:#34a853;border:none;border-radius:5px;cursor:pointer;font-size:11px;padding:3px 8px;font-weight:bold;margin-right:3px;}
  .btn-nome-cancel{background:var(--hover);color:var(--text3);border:none;border-radius:5px;cursor:pointer;font-size:11px;padding:3px 8px;}
  .tag-add{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:center;}
  .tag-add input{flex:1;padding:8px 12px;border:1px solid var(--input-border);border-radius:6px;font-size:14px;min-width:120px;background:var(--input-bg);color:var(--text);}
  .btn-at{padding:8px 16px;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;font-weight:bold;}
  .btn-at.nome{background:#1a73e8;} .btn-at.nome:hover{background:#1558b0;}
  .empty-tag{color:var(--text4);font-size:13px;font-style:italic;}
  .tag-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;min-height:36px;}
  .tag-item{display:flex;align-items:center;gap:6px;border-radius:20px;padding:5px 14px;font-size:13px;font-weight:bold;}
  .tag-item.c1{background:#f3e5f5;color:#9c27b0;} .tag-item.c2{background:#fff3e0;color:#e67e22;} .tag-item.c3{background:#e0f5f1;color:#16a085;}
  body.dark .tag-item.c1{background:#3a1a4a;color:#ce93d8;}
  body.dark .tag-item.c2{background:#3a2a10;color:#ffb74d;}
  body.dark .tag-item.c3{background:#0a2a25;color:#4db6ac;}
  .tag-item .del-tag{cursor:pointer;color:#ea4335;font-size:16px;}
  .btn-at.c1{background:#9c27b0;} .btn-at.c1:hover{background:#7b1fa2;}
  .btn-at.c2{background:#e67e22;} .btn-at.c2:hover{background:#ca6f1e;}
  .btn-at.c3{background:#16a085;} .btn-at.c3:hover{background:#117a65;}
  .sub-section{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:10px;}
  .sub-title{font-size:13px;font-weight:bold;margin-bottom:8px;}
  .sub-title.c1{color:#9c27b0;} .sub-title.c2{color:#e67e22;}
  .sel-parent{padding:7px 10px;border:1px solid var(--input-border);border-radius:6px;font-size:13px;min-width:160px;background:var(--input-bg);color:var(--text);}

  /* BACKUP */
  .backup-box{background:var(--surface);border-radius:10px;padding:20px;box-shadow:0 2px 8px var(--shadow);margin-bottom:20px;}
  .backup-box h3{font-size:15px;margin-bottom:6px;color:var(--text);}
  .backup-box p{font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.5;}
  .backup-actions{display:flex;gap:12px;flex-wrap:wrap;}
  .btn-backup{padding:10px 22px;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold;}
  .btn-backup.save{background:#1a73e8;} .btn-backup.restore{background:#e67e22;}
  .backup-status{display:none;padding:10px 14px;border-radius:8px;font-size:13px;margin-top:12px;font-weight:bold;}
  .backup-status.ok{background:#e6f4ea;color:#34a853;display:block;}

  /* REPORT */
  .report-layout{display:flex;gap:16px;align-items:flex-start;}
  .report-sidebar{width:230px;flex-shrink:0;}
  .report-main{flex:1;min-width:0;}
  .report-saved-list{background:var(--surface);border-radius:10px;box-shadow:0 2px 8px var(--shadow);overflow:hidden;margin-bottom:12px;}
  .report-saved-title{background:#1a73e8;color:white;padding:10px 14px;font-size:13px;font-weight:bold;}
  .report-saved-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;}
  .report-saved-item:last-child{border-bottom:none;}
  .report-saved-item:hover{background:var(--hover);}
  .report-saved-item.active{background:#e8f0fe;}
  body.dark .report-saved-item.active{background:#1e3a6e;}
  .report-saved-name{font-size:12px;font-weight:bold;color:var(--text);}
  .report-saved-type{font-size:10px;color:var(--text3);margin-top:2px;}
  .report-del-btn{background:#fce8e6;color:#ea4335;border:none;border-radius:4px;cursor:pointer;font-size:10px;padding:2px 6px;flex-shrink:0;}
  .report-empty-saved{padding:16px;text-align:center;color:var(--text4);font-size:12px;font-style:italic;}
  .report-config-box{background:var(--surface);border-radius:10px;padding:18px;box-shadow:0 2px 8px var(--shadow);margin-bottom:14px;}
  .report-config-title{font-size:14px;font-weight:bold;color:#1a73e8;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
  .report-field-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
  .report-field-label{font-size:12px;font-weight:bold;color:var(--text2);min-width:80px;}
  .report-select,.report-input{padding:7px 10px;border:1px solid var(--input-border);border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);flex:1;min-width:140px;}
  .report-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;}
  .btn-report{padding:9px 18px;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;transition:opacity .2s;}
  .btn-report:hover{opacity:.85;}
  .btn-report.run{background:#1a73e8;}
  .btn-report.save{background:#34a853;}
  .btn-report.print{background:#607d8b;}
  .report-name-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
  .report-name-input{flex:1;padding:7px 10px;border:2px solid #34a853;border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);min-width:160px;}
  .report-output{background:var(--surface);border-radius:10px;box-shadow:0 2px 8px var(--shadow);overflow:hidden;}
  .report-output-header{background:#1a73e8;color:white;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
  .report-output-title{font-size:14px;font-weight:bold;}
  .report-output-meta{font-size:11px;opacity:.85;}
  .report-table{width:100%;border-collapse:collapse;}
  .report-table th{background:#1a73e8;color:white;padding:8px 10px;text-align:left;font-size:clamp(9px,1.1vw,12px);white-space:nowrap;}
  .report-table td{padding:7px 10px;font-size:clamp(9px,1.1vw,12px);border-bottom:1px solid var(--border);color:var(--text);}
  .report-table tr:nth-child(even) td{background:var(--surface2);}
  .report-table tr:last-child td{border-bottom:none;}
  .report-table .td-num{text-align:right;font-family:monospace;font-size:clamp(9px,1.05vw,12px);letter-spacing:0.01em;white-space:nowrap;}
  .report-table .pos{color:#34a853;font-weight:bold;}
  .report-table .neg{color:#ea4335;font-weight:bold;}
  .report-table tfoot td{background:#e8f0fe;color:#1a73e8;font-weight:bold;font-size:12px;border-top:2px solid #1a73e8;}
  body.dark .report-table tfoot td{background:#1e3a6e;color:#7ec0f5;}
  .report-no-data{text-align:center;padding:30px;color:var(--text4);font-style:italic;}
  .report-type-badge{display:inline-block;border-radius:8px;padding:2px 8px;font-size:10px;font-weight:bold;}
  .rtb-estratto{background:#e8f0fe;color:#1a73e8;}
  .rtb-categoria{background:#f3e5f5;color:#9c27b0;}
  .rtb-tipo{background:#fff3e0;color:#e67e22;}
  .rtb-date{background:#e0f5f1;color:#16a085;}
  .rtb-saldo{background:#fce8e6;color:#c0392b;}
  .rtb-fx{background:#fff8e1;color:#f57f17;}
  body.dark .rtb-estratto{background:#1e3a6e;color:#7ec0f5;}
  body.dark .rtb-categoria{background:#3a1a4a;color:#ce93d8;}
  body.dark .rtb-tipo{background:#3a2a10;color:#ffb74d;}
  body.dark .rtb-date{background:#0a2a25;color:#4db6ac;}
  body.dark .rtb-saldo{background:#4a1a1a;color:#ff6b6b;}
  body.dark .rtb-fx{background:#2a2000;color:#ffd54f;}
  .report-section-header{background:var(--surface2);border-top:2px solid var(--border);font-weight:bold;font-size:11px;color:var(--text2);}
  .report-section-header td{padding:6px 10px;}
  .cur-section-header{background:rgba(26,115,232,.08);border-top:3px solid #1a73e8;}
  body.dark .cur-section-header{background:rgba(74,144,217,.1);}
  .cur-section-header td{padding:8px 10px;font-weight:bold;color:#1a73e8;font-size:12px;}

  @media(max-width:700px){
    .report-layout{flex-direction:column;}
    .report-sidebar{width:100%;}
  }
  @media print{
    body{background:white!important;padding:10px;}
    nav,.filter-toggle-bar,.filter-panel,.insert-box,.row-actions,.entity-banner,.btn-settings,.settings-overlay,
    .report-sidebar,.report-config-box,.report-actions,.fx-row{display:none!important;}
    .page{display:block!important;}
    #page-nomi,#page-categorie,#page-backup,#page-registro{display:none!important;}
    #page-report{display:block!important;}
    .report-layout{display:block!important;}
    .report-output{box-shadow:none!important;}
    .report-table th{background:#1a73e8!important;color:white!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    .report-table tfoot td{background:#e8f0fe!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    .report-output-header{background:#1a73e8!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
  }
</style>
</head>
<body>

<div class="login-wrapper" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <svg width="60" height="60" viewBox="0 0 52 52">
        <ellipse cx="26" cy="30" rx="22" ry="10" fill="none" stroke="#1a3a8f" stroke-width="2.2" stroke-dasharray="100 8" transform="rotate(-18 26 30)"/>
        <circle cx="13" cy="7" r="4.5" fill="#1a5fbf"/>
        <circle cx="24" cy="3.5" r="3" fill="#2980d9"/>
        <circle cx="34" cy="5" r="2" fill="#5ba4e8"/>
        <circle cx="41" cy="9" r="1.4" fill="#7ec0f5"/>
        <path d="M20 38 C18 38 15 35 15 28 C15 20 19 14 26 14 C33 14 37 20 37 28 C37 35 34 38 32 38 Z" fill="url(#hg2)"/>
        <defs><linearGradient id="hg2" x1="15" y1="14" x2="37" y2="40"><stop offset="0%" stop-color="#2060c0"/><stop offset="100%" stop-color="#0a2a7a"/></linearGradient></defs>
      </svg>
      <div class="login-title"><span style="color:#1a5fbf;">ILTUO</span><span style="color:#e67e22;">CAVEAU</span></div>
      <div class="login-subtitle">Conoscenza, Azione, Libert√†</div>
    </div>
    <div id="loginError" class="login-error" style="display:none"></div>
    <form class="login-form" onsubmit="handleLogin(event)">
      <input type="email" class="login-input" id="loginEmail" placeholder="Email" required autocomplete="email">
      <input type="password" class="login-input" id="loginPassword" placeholder="Password" required autocomplete="current-password">
      <button type="submit" class="login-btn" id="loginBtn">üîí Accedi</button>
    </form>
    <div style="text-align:center;color:var(--text3);font-size:13px;margin-top:16px;display:none" id="loginLoading">Caricamento...</div>
  </div>
</div>

<div id="app">
  <!-- Settings -->
  <div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
    <div class="settings-panel">
      <h3>‚öôÔ∏è Impostazioni</h3>
      <div class="settings-row">
        <label>üåô Tema scuro</label>
        <div class="toggle-wrap">
          <span class="toggle-label" id="themeLabel">Chiaro</span>
          <label class="toggle"><input type="checkbox" id="darkToggle" onchange="toggleDark(this.checked)"><span class="toggle-slider"></span></label>
        </div>
      </div>
      <div class="settings-row">
        <label>üí± Valuta di riferimento</label>
        <select class="settings-select" id="refCurrSel" onchange="setRefCurr(this.value)">
          <option value="EUR">‚Ç¨ Euro</option>
          <option value="GBP">¬£ Sterlina</option>
          <option value="AED">AED Dirham</option>
        </select>
      </div>
      <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:6px;">
        <label>üì° Tassi FX (aggiornati)</label>
        <div id="fxRateDisplay" style="font-size:11px;color:var(--text3);line-height:1.7;"></div>
        <button onclick="fetchFxRates(true)" style="background:#e8f0fe;color:#1a73e8;border:none;border-radius:6px;padding:5px 12px;cursor:pointer;font-size:12px;font-weight:bold;">üîÑ Aggiorna tassi</button>
      </div>
      <button class="btn-close-settings" onclick="closeSettings()">Chiudi</button>
    </div>
  </div>

  <div class="app-header">
    <div class="logo-wrap">
      <svg width="52" height="52" viewBox="0 0 52 52">
        <ellipse cx="26" cy="30" rx="22" ry="10" fill="none" stroke="#1a3a8f" stroke-width="2.2" stroke-dasharray="100 8" transform="rotate(-18 26 30)"/>
        <circle cx="13" cy="7" r="4.5" fill="#1a5fbf"/>
        <circle cx="24" cy="3.5" r="3" fill="#2980d9"/>
        <circle cx="34" cy="5" r="2" fill="#5ba4e8"/>
        <circle cx="41" cy="9" r="1.4" fill="#7ec0f5"/>
        <path d="M20 38 C18 38 15 35 15 28 C15 20 19 14 26 14 C33 14 37 20 37 28 C37 35 34 38 32 38 Z" fill="url(#hg)"/>
        <defs><linearGradient id="hg" x1="15" y1="14" x2="37" y2="40"><stop offset="0%" stop-color="#2060c0"/><stop offset="100%" stop-color="#0a2a7a"/></linearGradient></defs>
      </svg>
      <div style="line-height:1.15;">
        <div style="font-size:17px;font-weight:900;letter-spacing:.5px;"><span style="color:#1a5fbf;">ILTUO</span><span style="color:#e67e22;">CAVEAU</span></div>
        <div style="font-size:9px;color:#7a9abf;letter-spacing:1.5px;font-style:italic;">Conoscenza, Azione, Libert√†</div>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info">üë§ <span id="userEmail"></span></div>
      <button class="btn-action purple" onclick="stampaPDF()">üñ®Ô∏è PDF</button>
      <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è</button>
      <button class="btn-logout" onclick="handleLogout()">Esci</button>
    </div>
  </div>

  <nav>
    <button class="nav-btn active" onclick="goTo('registro')">üìã Registro</button>
    <button class="nav-btn" onclick="goTo('report')">üìä Report</button>
    <button class="nav-btn" onclick="goTo('nomi')">üë§ Nomi</button>
    <button class="nav-btn" onclick="goTo('categorie')">üè∑Ô∏è Categorie</button>
    <button class="nav-btn" onclick="goTo('backup')">üíæ Backup</button>
  </nav>

  <!-- ‚ïê‚ïê‚ïê REGISTRO ‚ïê‚ïê‚ïê -->
  <div class="page active" id="page-registro">
    <h2>üí∏ Registro Movimenti</h2>
    <div class="entity-banner" id="entityBanner">
      <span id="entityBannerLabel"></span>
      <button onclick="clearEntityFilter()">‚úï Rimuovi filtro</button>
    </div>

    <!-- Summary cards per valuta -->
    <div id="summaryArea"></div>

    <div class="filter-toggle-bar" id="filterToggleBar" onclick="toggleFilterPanel()">
      <div class="filter-toggle-left">üîç Filtri <span class="filter-active-badge" id="filterBadge">0 attivi</span></div>
      <div class="filter-toggle-right"><span class="filter-chevron" id="filterChevron">‚ñº</span></div>
    </div>
    <div class="filter-panel" id="filterPanel">
      <div class="filter-row">
        <span class="filter-label">üë§ Entit√†:</span>
        <div class="entity-filter-wrap">
          <select class="entity-select" id="entitySel" onchange="onEntitySelChange()"><option value="">‚Äî Tutti ‚Äî</option></select>
          <button class="btn-sm grey" onclick="clearEntityFilter()">‚úï</button>
        </div>
      </div>
      <div class="filter-row">
        <span class="filter-label">üè∑Ô∏è Tipo:</span>
        <div class="entity-filter-wrap">
          <select class="tipo-select" id="tipoSel" onchange="onTipoSelChange()"><option value="">‚Äî Tutti i tipi ‚Äî</option></select>
          <button class="btn-sm grey" onclick="clearTipoFilter()">‚úï</button>
        </div>
      </div>
      <div class="filter-row">
        <span class="filter-label">üí± Valuta:</span>
        <div class="entity-filter-wrap">
          <select class="val-select" id="valutaSel" onchange="onValutaSelChange()">
            <option value="">‚Äî Tutte ‚Äî</option>
            <option value="EUR">‚Ç¨ Euro</option>
            <option value="GBP">¬£ Sterlina</option>
            <option value="AED">AED Dirham</option>
          </select>
          <button class="btn-sm grey" onclick="clearValutaFilter()">‚úï</button>
        </div>
      </div>
      <div class="filter-row">
        <span class="filter-label">üìÖ Periodo:</span>
        <div class="date-range">
          <input type="date" id="dateFrom" onchange="updateFilterBadge();render()">
          <span>‚Üí</span>
          <input type="date" id="dateTo" onchange="updateFilterBadge();render()">
          <button class="btn-sm red" onclick="clearDate()">‚úï</button>
        </div>
      </div>
      <div class="filter-row">
        <span class="filter-label">üè∑Ô∏è Cat:</span>
        <div class="multi-select-wrap"><div class="mst" id="trC1" onclick="toggleDD('ddC1',event)">Tutte cat.1</div><div class="dropdown-panel" id="ddC1"></div></div>
        <div class="multi-select-wrap"><div class="mst" id="trC2" onclick="toggleDD('ddC2',event)">Tutte cat.2</div><div class="dropdown-panel" id="ddC2"></div></div>
        <div class="multi-select-wrap"><div class="mst" id="trC3" onclick="toggleDD('ddC3',event)">Tutte cat.3</div><div class="dropdown-panel" id="ddC3"></div></div>
      </div>
      <div class="filter-reset-row"><button class="btn-sm grey" onclick="clearFilters()">‚úï Reset filtri</button></div>
    </div>

    <!-- Insert box -->
    <div class="insert-box">
      <div class="insert-box-title">‚ûï Nuovo Movimento</div>
      <div class="controls">
        <input type="date" id="data"/>
        <select id="selFrom" onchange="onFromChange()"><option value="">‚Äî From ‚Äî</option></select>
        <span class="arrow-label">‚Üí</span>
        <select id="selTo" onchange="onToChange()"><option value="">‚Äî To ‚Äî</option></select>
        <input type="text" id="descrizione" placeholder="Descrizione..."/>
        <select id="selC1" onchange="onC1Change()"><option value="">‚Äî Cat.1 ‚Äî</option></select>
        <select id="selC2" onchange="onC2Change()" disabled><option value="">‚Äî Cat.2 ‚Äî</option></select>
        <select id="selC3" disabled><option value="">‚Äî Cat.3 ‚Äî</option></select>
        <input type="number" id="importo" placeholder="Importo" min="0" step="0.01" oninput="onImportoChange()"/>
        <span id="curFromBadge" style="font-size:13px;font-weight:bold;color:#1a73e8;min-width:30px;"></span>
        <button class="btn-add" onclick="aggiungi()">+ Aggiungi</button>
      </div>
      <!-- FX row (exchange) -->
      <div class="fx-row" id="fxRow" style="display:none">
        <span class="fx-label">üí± Exchange:</span>
        <span id="fxFromLabel" style="font-size:12px;font-weight:bold;color:var(--text2);"></span>
        <span style="color:var(--text3);font-size:13px;">‚Üí</span>
        <input type="number" id="importoTo" placeholder="Importo ricevuto" min="0" step="0.01" style="flex:1;min-width:100px;padding:5px 8px;border:1px solid #e67e22;border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);" oninput="onImportoToChange()">
        <span id="curToBadge" style="font-size:13px;font-weight:bold;color:#e67e22;min-width:30px;"></span>
        <span class="fx-badge" id="fxRateBadge">Tasso: ‚Äî</span>
        <span class="fx-loading" id="fxLoading" style="display:none">‚è≥ Recupero tasso...</span>
        <input type="number" id="tassoFX" placeholder="Tasso (auto)" step="0.0001" style="flex:1;min-width:80px;padding:5px 8px;border:1px solid var(--input-border);border-radius:6px;font-size:12px;background:var(--input-bg);color:var(--text);" oninput="onTassoChange()">
      </div>
    </div>

    <table>
      <thead><tr>
        <th class="sortable" onclick="setSort('data')">Data <span id="sh-data">‚áÖ</span></th>
        <th class="sortable" onclick="setSort('from')">From <span id="sh-from">‚áÖ</span></th>
        <th class="sortable" onclick="setSort('to')">To <span id="sh-to">‚áÖ</span></th>
        <th class="sortable" onclick="setSort('desc')">Descrizione <span id="sh-desc">‚áÖ</span></th>
        <th class="sortable" onclick="setSort('c1')">Cat.1 <span id="sh-c1">‚áÖ</span></th>
        <th class="sortable" onclick="setSort('importo')">Importo <span id="sh-importo">‚áÖ</span></th>
        <th>Valuta</th>
        <th>Segno</th>
        <th></th>
      </tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ‚ïê‚ïê‚ïê REPORT ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-report">
    <h2>üìä Report</h2>
    <div class="report-layout">
      <div class="report-sidebar">
        <div class="report-saved-list">
          <div class="report-saved-title">üìÅ Report Salvati</div>
          <div id="reportSavedList"><div class="report-empty-saved">Nessun report salvato</div></div>
        </div>
        <button class="btn-report run" style="width:100%;margin-top:4px;" onclick="newReport()">+ Nuovo Report</button>
      </div>
      <div class="report-main">
        <div class="report-config-box" id="reportConfigBox">
          <div class="report-config-title">‚öôÔ∏è Configurazione Report</div>
          <div class="report-name-row">
            <span class="report-field-label" style="min-width:80px;font-size:12px;font-weight:bold;color:var(--text2);">Nome:</span>
            <input type="text" class="report-name-input" id="rptName" placeholder="Nome report...">
          </div>
          <div class="report-field-row">
            <span class="report-field-label">Tipo:</span>
            <select class="report-select" id="rptType" onchange="onRptTypeChange()">
              <option value="estratto">üìÑ Estratto conto entit√†</option>
              <option value="categoria">üè∑Ô∏è Riepilogo per categoria</option>
              <option value="tipo">üë• Riepilogo per tipo</option>
              <option value="date">üìÖ Movimenti per periodo</option>
              <option value="saldo">üìà Saldo per entit√†</option>
              <option value="fx">üí± Report Exchange FX</option>
            </select>
          </div>
          <div id="rptParams">
            <div id="rptParamEstrato">
              <div class="report-field-row">
                <span class="report-field-label">Entit√†:</span>
                <select class="report-select" id="rptEntity"><option value="">‚Äî Seleziona ‚Äî</option></select>
              </div>
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFrom">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptTo">
              </div>
            </div>
            <div id="rptParamCategoria" style="display:none">
              <div class="report-field-row">
                <span class="report-field-label">Cat.1:</span>
                <select class="report-select" id="rptC1"><option value="">‚Äî Tutte ‚Äî</option></select>
              </div>
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFromCat">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptToCat">
              </div>
            </div>
            <div id="rptParamTipo" style="display:none">
              <div class="report-field-row">
                <span class="report-field-label">Tipo:</span>
                <select class="report-select" id="rptTipoSel"><option value="">‚Äî Tutti ‚Äî</option></select>
              </div>
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFromTipo">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptToTipo">
              </div>
            </div>
            <div id="rptParamDate" style="display:none">
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFromDate">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptToDate">
              </div>
            </div>
            <div id="rptParamSaldo" style="display:none">
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFromSaldo">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptToSaldo">
              </div>
            </div>
            <div id="rptParamFx" style="display:none">
              <div class="report-field-row">
                <span class="report-field-label">Dal:</span>
                <input type="date" class="report-input" id="rptFromFx">
                <span class="report-field-label" style="min-width:30px;text-align:center;">Al:</span>
                <input type="date" class="report-input" id="rptToFx">
              </div>
            </div>
          </div>
          <div class="report-actions">
            <button class="btn-report run" onclick="runReport()">‚ñ∂ Genera</button>
            <button class="btn-report save" onclick="saveReport()">üíæ Salva</button>
            <button class="btn-report print" onclick="printReport()">üñ®Ô∏è Stampa / PDF</button>
          </div>
        </div>
        <div class="report-output" id="reportOutput" style="display:none">
          <div class="report-output-header">
            <div class="report-output-title" id="rptOutTitle">Report</div>
            <div class="report-output-meta" id="rptOutMeta"></div>
          </div>
          <div id="rptOutBody"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê NOMI ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-nomi">
    <h2>üë§ Archivio Nomi</h2>
    <div class="archivio-box">
      <div class="insert-box-title" style="color:#1a73e8;font-size:13px;font-weight:bold;margin-bottom:10px;">‚ûï Nuovo Nome</div>
      <div class="tag-add" style="margin-top:0;margin-bottom:0;">
        <input type="text" id="inputNome" placeholder="Nome..." onkeydown="if(event.key==='Enter')addNome()"/>
        <input type="text" id="inputNomeTipo" placeholder="Tipo..." list="tipoSuggest"/>
        <datalist id="tipoSuggest"></datalist>
        <select id="inputNomeVal" style="padding:8px 10px;border:1px solid var(--input-border);border-radius:6px;font-size:13px;background:var(--input-bg);color:var(--text);">
          <option value="EUR">‚Ç¨ Euro</option>
          <option value="GBP">¬£ Sterlina</option>
          <option value="AED">AED Dirham</option>
        </select>
        <button class="btn-at nome" onclick="addNome()">+ Aggiungi</button>
      </div>
    </div>
    <div class="archivio-box">
      <h3>Nomi / Entit√† salvati</h3>
      <p style="font-size:12px;color:var(--text3);margin-bottom:12px;">Il campo <strong>Valuta</strong> determina la valuta nativa del conto/entit√†. Il campo <strong>Tipo</strong> raggruppa i nomi nei report.</p>
      <table class="nomi-table">
        <thead style="background:#1a73e8;"><tr><th style="background:#1a73e8;">Nome</th><th style="background:#1a73e8;">Tipo</th><th style="background:#1a73e8;">Valuta</th><th style="background:#1a73e8;">Azioni</th></tr></thead>
        <tbody id="nomiTbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê CATEGORIE ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-categorie">
    <h2>üè∑Ô∏è Archivio Categorie</h2>
    <div style="display:flex;justify-content:flex-end;margin-bottom:12px;">
      <button onclick="stampaCategorie()" style="padding:8px 18px;background:#607d8b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:bold;">üñ®Ô∏è Stampa Categorie</button>
    </div>
    <div class="archivio-box">
      <h3>üü£ Categoria 1</h3>
      <div class="tag-list" id="c1List"></div>
      <div class="tag-add">
        <input type="text" id="inputC1" placeholder="Nuova cat.1..." onkeydown="if(event.key==='Enter')addC1()"/>
        <button class="btn-at c1" onclick="addC1()">+ Aggiungi</button>
      </div>
    </div>
    <div class="archivio-box">
      <h3>üü† Categoria 2</h3>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <label style="font-size:13px;font-weight:bold;color:var(--text2)">Cat.1:</label>
        <select class="sel-parent" id="c1ForC2" onchange="renderC2Page()"><option value="">‚Äî Seleziona ‚Äî</option></select>
      </div>
      <div id="c2Section" class="sub-section"><span class="empty-tag">Seleziona Cat.1</span></div>
      <div class="tag-add" id="c2AddRow" style="display:none">
        <input type="text" id="inputC2" placeholder="Nuova cat.2..." onkeydown="if(event.key==='Enter')addC2()"/>
        <button class="btn-at c2" onclick="addC2()">+ Aggiungi</button>
      </div>
    </div>
    <div class="archivio-box">
      <h3>üü¢ Categoria 3</h3>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <label style="font-size:13px;font-weight:bold;color:var(--text2)">Cat.1:</label>
        <select class="sel-parent" id="c1ForC3" onchange="syncC2ForC3();renderC3Page()"><option value="">‚Äî Seleziona ‚Äî</option></select>
        <label style="font-size:13px;font-weight:bold;color:var(--text2)">Cat.2:</label>
        <select class="sel-parent" id="c2ForC3" onchange="renderC3Page()"><option value="">‚Äî Seleziona ‚Äî</option></select>
      </div>
      <div id="c3Section" class="sub-section"><span class="empty-tag">Seleziona Cat.1 e Cat.2</span></div>
      <div class="tag-add" id="c3AddRow" style="display:none">
        <input type="text" id="inputC3" placeholder="Nuova cat.3..." onkeydown="if(event.key==='Enter')addC3()"/>
        <button class="btn-at c3" onclick="addC3()">+ Aggiungi</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê BACKUP ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-backup">
    <h2>üíæ Backup</h2>
    <div class="backup-box">
      <h3>‚¨áÔ∏è Esporta dati locali</h3>
      <p>Scarica i dati in formato JSON.</p>
      <div class="backup-actions"><button class="btn-backup save" onclick="salvaBackup()">üíæ Scarica JSON</button></div>
    </div>
    <div class="backup-box">
      <h3>‚òÅÔ∏è Sincronizzazione</h3>
      <p>I tuoi dati sono automaticamente sincronizzati su Firebase Realtime Database.</p>
      <div class="backup-status ok" style="display:block">‚úÖ Sincronizzato con Firebase</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
import { getDatabase, ref, set, get, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyDbCbpwgdlPbRUlppCFX-dsbNEuyzBpVV4",
  authDomain: "caveau-registro.firebaseapp.com",
  databaseURL: "https://caveau-registro-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "caveau-registro",
  storageBucket: "caveau-registro.firebasestorage.app",
  messagingSenderId: "361376077124",
  appId: "1:361376077124:web:411566edcc50463ce6b311"
};

const fbApp = initializeApp(firebaseConfig);
const auth = getAuth(fbApp);
const db = getDatabase(fbApp);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rows=[], nomi=[], c1=[], c2Map={}, c3Map={}, savedReports=[];
let fC1=new Set(), fC2=new Set(), fC3=new Set();
let entityFilter='', tipoFilter='', valutaFilter='';
let editingIdx=null, editingNomeIdx=null;
let sortField='data', sortDir=1, filterOpen=false;
let currentUser=null, activeReportIdx=null;
let refCurr='EUR';
// Live FX rates (base EUR)
let fxRates = { EUR:1, GBP:0.853, AED:3.972 }; // fallback
let fxLoaded = false;

// ‚îÄ‚îÄ CURRENCY UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CUR_SYMBOLS = { EUR:'‚Ç¨', GBP:'¬£', AED:'AED', '':'?' };
const CUR_CLASSES = { EUR:'cur-eur', GBP:'cur-gbp', AED:'cur-aed' };

function curSymbol(c){ return CUR_SYMBOLS[c]||c; }
function curClass(c){ return CUR_CLASSES[c]||'cur-other'; }
function getNomeValuta(name){ const n=nomi.find(x=>x.name===name); return n?n.valuta||'EUR':'EUR'; }

function fmtAmt(amount, cur){
  const sym = curSymbol(cur||'EUR');
  const parts = Math.abs(amount).toFixed(2).split('.');
  parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  const neg = amount < 0 ? '-' : '';
  if(cur==='AED') return `${neg}${parts[0]},${parts[1]} ${sym}`;
  return `${neg}${sym}\u00a0${parts[0]},${parts[1]}`;
}

function isExchangeRow(r){ return !!(r.isExchange && r.valutaTo && r.valutaTo !== r.valuta); }

// ‚îÄ‚îÄ FX RATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function fetchFxRates(force=false){
  try {
    const cacheKey = 'fxRates_v2', cacheTimeKey = 'fxRatesTime';
    const now = Date.now();
    if(!force){
      try {
        const cached = localStorage.getItem(cacheKey);
        const t = parseInt(localStorage.getItem(cacheTimeKey)||'0');
        if(cached && (now-t) < 4*3600*1000){ fxRates = JSON.parse(cached); fxLoaded=true; updateFxDisplay(); return; }
      } catch(e){}
    }
    const res = await fetch('https://open.er-api.com/v6/latest/EUR');
    const data = await res.json();
    if(data.rates){
      fxRates = { EUR:1, GBP: data.rates.GBP, AED: data.rates.AED };
      fxLoaded = true;
      try { localStorage.setItem(cacheKey, JSON.stringify(fxRates)); localStorage.setItem(cacheTimeKey, String(now)); } catch(e){}
      updateFxDisplay();
    }
  } catch(e){ console.warn('FX fetch failed, using fallback',e); updateFxDisplay(); }
}

function updateFxDisplay(){
  const el = document.getElementById('fxRateDisplay');
  if(!el) return;
  el.innerHTML = `1 EUR = ${fxRates.GBP?.toFixed(4)||'‚Äî'} GBP<br>1 EUR = ${fxRates.AED?.toFixed(4)||'‚Äî'} AED<br>1 GBP = ${(fxRates.AED/fxRates.GBP)?.toFixed(4)||'‚Äî'} AED`;
}

// Tasso da curFrom a curTo
function getRate(from, to){
  if(from===to) return 1;
  // tassi base EUR
  const rFrom = fxRates[from]||1;
  const rTo   = fxRates[to]||1;
  return rTo/rFrom; // 1 from = ? to
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.handleLogin = async (e) => {
  e.preventDefault();
  const email=document.getElementById('loginEmail').value, pass=document.getElementById('loginPassword').value;
  const btn=document.getElementById('loginBtn'), err=document.getElementById('loginError');
  btn.disabled=true; btn.textContent='‚è≥ Accesso...'; err.style.display='none';
  try { await signInWithEmailAndPassword(auth, email, pass); }
  catch(error) {
    err.textContent = error.code==='auth/invalid-credential'?'‚ùå Email o password errati':'‚ùå Errore: '+error.message;
    err.style.display='block'; btn.disabled=false; btn.textContent='üîí Accedi';
  }
};
window.handleLogout = async () => { if(confirm('Uscire?')) await signOut(auth); };

onAuthStateChanged(auth, async (user) => {
  if(user){
    currentUser=user;
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('loginLoading').style.display='block';
    document.getElementById('userEmail').textContent=user.email;
    fetchFxRates();
    const userRef=ref(db,'users/'+user.uid);
    const snap=await get(userRef);
    if(snap.exists()){ loadData(snap.val()); }
    onValue(userRef, snap2 => {
      if(snap2.exists()){ loadData(snap2.val()); syncSelects();syncTipoSel();rebuildDD();render();
        if(document.getElementById('page-nomi').classList.contains('active')) renderNomiPage();
        if(document.getElementById('page-categorie').classList.contains('active')){ renderC1Page();syncParentSelects();renderC2Page();syncC2ForC3();renderC3Page(); }
        if(document.getElementById('page-report').classList.contains('active')){ syncReportSelects();renderSavedReports(); }
      }
    });
    document.getElementById('app').classList.add('loaded');
    document.getElementById('app').style.display='block';
    document.getElementById('data').valueAsDate=new Date();
    syncSelects(); syncTipoSel(); updateSortHeaders(); render();
  } else {
    document.getElementById('loginScreen').style.display='flex';
    document.getElementById('app').classList.remove('loaded');
    document.getElementById('app').style.display='none';
  }
});

function loadData(d){
  rows=d.rows||[]; nomi=d.nomi||[]; c1=d.c1||[]; c2Map=d.c2Map||{}; c3Map=d.c3Map||{};
  savedReports=d.savedReports||[]; refCurr=d.refCurr||'EUR';
  // migrate legacy rows: set valuta from nomi if missing
  rows.forEach(r=>{ if(!r.valuta) r.valuta=getNomeValuta(r.from); });
}

async function saveToFirebase(){
  if(!currentUser) return;
  await set(ref(db,'users/'+currentUser.uid), { rows, nomi, c1, c2Map, c3Map, savedReports, refCurr, lastModified:new Date().toISOString() });
}

// ‚îÄ‚îÄ THEME / SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDark(on){ document.body.classList.toggle('dark',on); document.getElementById('themeLabel').textContent=on?'Scuro':'Chiaro'; try{localStorage.setItem('theme',on?'dark':'light');}catch(e){} }
try{ if(localStorage.getItem('theme')==='dark'){ document.body.classList.add('dark'); document.getElementById('darkToggle').checked=true; document.getElementById('themeLabel').textContent='Scuro'; } }catch(e){}
function openSettings(){ updateFxDisplay(); document.getElementById('refCurrSel').value=refCurr; document.getElementById('settingsOverlay').classList.add('open'); }
function closeSettings(){ document.getElementById('settingsOverlay').classList.remove('open'); }
function closeSettingsOutside(e){ if(e.target===document.getElementById('settingsOverlay'))closeSettings(); }
async function setRefCurr(v){ refCurr=v; await saveToFirebase(); renderSummary(); }
window.fetchFxRates = fetchFxRates;

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(p){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  document.querySelectorAll('.nav-btn')[['registro','report','nomi','categorie','backup'].indexOf(p)].classList.add('active');
  if(p==='registro'){rebuildDD();render();}
  if(p==='nomi') renderNomiPage();
  if(p==='categorie'){renderC1Page();syncParentSelects();renderC2Page();syncC2ForC3();renderC3Page();}
  if(p==='report'){syncReportSelects();renderSavedReports();}
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function c3k(a,b){ return a+'|'+b; }
function getTipi(){ return [...new Set(nomi.map(n=>n.tipo).filter(Boolean))].sort(); }
function getTipoNome(name){ const n=nomi.find(x=>x.name===name); return n?n.tipo||'':''; }
function fmtDate(s){ return s?s.split('-').reverse().join('/'):''; }

// ‚îÄ‚îÄ SUMMARY CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSummary(){
  const filtered = getFiltered();
  // Group by currency
  const byCur = {};
  filtered.forEach(r=>{
    const cur = r.valuta||'EUR';
    if(!byCur[cur]) byCur[cur]={in:0,out:0};
    if(entityFilter){
      if(r.to===entityFilter) byCur[cur].in+=r.importo;
      else if(r.from===entityFilter) byCur[cur].out+=r.importo;
    } else {
      byCur[cur].in+=r.importo;
    }
    // If exchange, also track destination currency
    if(isExchangeRow(r) && r.importoTo && r.valutaTo){
      const ct = r.valutaTo;
      if(!byCur[ct]) byCur[ct]={in:0,out:0};
      if(entityFilter){ if(r.to===entityFilter) byCur[ct].in+=r.importoTo; }
    }
  });

  const currencies = Object.keys(byCur).sort();
  let html='';
  if(currencies.length===0){
    html=`<div class="summary">
      <div class="card in"><label>Entrate</label><span>‚Äî</span></div>
      <div class="card out"><label>Uscite</label><span>‚Äî</span></div>
      <div class="card neutral"><label>Movimenti</label><span>${filtered.length}</span></div>
    </div>`;
  } else {
    html='<div class="summary">';
    currencies.forEach(cur=>{
      const d=byCur[cur], saldo=d.in-d.out;
      if(d.in>0) html+=`<div class="card in"><label>${curSymbol(cur)} Entrate</label><span>${fmtAmt(d.in,cur)}</span></div>`;
      if(d.out>0) html+=`<div class="card out"><label>${curSymbol(cur)} Uscite</label><span>${fmtAmt(d.out,cur)}</span></div>`;
      if(d.in>0||d.out>0) html+=`<div class="card ${saldo>=0?'saldo-pos':'saldo-neg'}"><label>${curSymbol(cur)} Saldo</label><span>${fmtAmt(saldo,cur)}</span></div>`;
    });
    html+=`<div class="card neutral"><label>Movimenti</label><span>${filtered.length}</span></div>`;
    html+='</div>';
  }
  document.getElementById('summaryArea').innerHTML=html;
}

// ‚îÄ‚îÄ FILTER / SORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleFilterPanel(){
  filterOpen=!filterOpen;
  document.getElementById('filterPanel').classList.toggle('open',filterOpen);
  document.getElementById('filterToggleBar').classList.toggle('open',filterOpen);
  document.getElementById('filterChevron').classList.toggle('open',filterOpen);
}
function updateFilterBadge(){
  let n=0;
  if(entityFilter)n++; if(tipoFilter)n++; if(valutaFilter)n++;
  if(document.getElementById('dateFrom').value||document.getElementById('dateTo').value)n++;
  if(fC1.size>0)n++; if(fC2.size>0)n++; if(fC3.size>0)n++;
  const badge=document.getElementById('filterBadge');
  badge.textContent=n+' attiv'+(n===1?'o':'i'); badge.classList.toggle('show',n>0);
}
document.addEventListener('click',e=>{ document.querySelectorAll('.dropdown-panel').forEach(p=>{ if(!p.closest('.multi-select-wrap').contains(e.target))p.classList.remove('open'); }); });
function toggleDD(id,e){ e.stopPropagation(); const p=document.getElementById(id),was=p.classList.contains('open'); document.querySelectorAll('.dropdown-panel').forEach(x=>x.classList.remove('open')); if(!was)p.classList.add('open'); }

function syncTipoSel(){
  const sel=document.getElementById('tipoSel'),prev=tipoFilter;
  sel.innerHTML='<option value="">‚Äî Tutti i tipi ‚Äî</option>'+getTipi().map(t=>`<option value="${t}" ${t===prev?'selected':''}>${t}</option>`).join('');
  sel.className=prev?'tipo-select active-sel':'tipo-select';
}
function onTipoSelChange(){ tipoFilter=document.getElementById('tipoSel').value; document.getElementById('tipoSel').className=tipoFilter?'tipo-select active-sel':'tipo-select'; updateFilterBadge();render(); }
function clearTipoFilter(){ tipoFilter=''; document.getElementById('tipoSel').value=''; document.getElementById('tipoSel').className='tipo-select'; updateFilterBadge();render(); }
function onValutaSelChange(){ valutaFilter=document.getElementById('valutaSel').value; document.getElementById('valutaSel').className=valutaFilter?'val-select active-sel':'val-select'; updateFilterBadge();render(); }
function clearValutaFilter(){ valutaFilter=''; document.getElementById('valutaSel').value=''; document.getElementById('valutaSel').className='val-select'; updateFilterBadge();render(); }

function setSort(field){ if(sortField===field)sortDir*=-1; else{sortField=field;sortDir=1;} updateSortHeaders();render(); }
function updateSortHeaders(){
  ['data','from','to','desc','c1','importo'].forEach(f=>{
    const el=document.getElementById('sh-'+f); if(!el)return;
    el.textContent=f===sortField?(sortDir===1?'‚ñ≤':'‚ñº'):'‚áÖ'; el.style.opacity=f===sortField?'1':'0.35'; el.style.fontSize='10px';
  });
}
function getSorted(arr){
  return [...arr].sort((a,b)=>{
    let va=a[sortField], vb=b[sortField];
    if(sortField==='importo'){ va=parseFloat(va)||0; vb=parseFloat(vb)||0; return (va-vb)*sortDir; }
    return String(va||'').localeCompare(String(vb||''),'it')*sortDir;
  });
}
function getFiltered(){
  const from=document.getElementById('dateFrom').value, to=document.getElementById('dateTo').value;
  return rows.filter(r=>{
    if(from&&r.data<from)return false;
    if(to&&r.data>to)return false;
    if(entityFilter&&r.from!==entityFilter&&r.to!==entityFilter)return false;
    if(tipoFilter){ const ftm=getTipoNome(r.from)===tipoFilter, ttm=getTipoNome(r.to)===tipoFilter; if(!ftm&&!ttm)return false; }
    if(valutaFilter&&r.valuta!==valutaFilter&&r.valutaTo!==valutaFilter)return false;
    if(fC1.size>0&&!fC1.has(r.c1))return false;
    if(fC2.size>0&&!fC2.has(r.c2))return false;
    if(fC3.size>0&&!fC3.has(r.c3))return false;
    return true;
  });
}
function clearFilters(){ fC1.clear();fC2.clear();fC3.clear(); document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value=''; clearEntityFilter();clearTipoFilter();clearValutaFilter();rebuildDD();updateFilterBadge();render(); }
function clearDate(){ document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value=''; updateFilterBadge();render(); }

// ‚îÄ‚îÄ SELECTS SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function syncSelects(){
  const ns=[...nomi].sort((a,b)=>a.name.localeCompare(b.name,'it'));
  const opts='<option value="">‚Äî</option>'+ns.map(n=>`<option value="${n.name}">${n.name} (${curSymbol(n.valuta||'EUR')})</option>`).join('');
  document.getElementById('selFrom').innerHTML=opts;
  document.getElementById('selTo').innerHTML=opts;
  const c1s=[...c1].sort((a,b)=>a.localeCompare(b,'it'));
  document.getElementById('selC1').innerHTML='<option value="">‚Äî Cat.1 ‚Äî</option>'+c1s.map(c=>`<option value="${c}">${c}</option>`).join('');
  onC1Change(); syncEntitySel();
}
function syncEntitySel(){
  const sel=document.getElementById('entitySel'),prev=entityFilter;
  const ns=[...nomi].sort((a,b)=>a.name.localeCompare(b.name,'it'));
  sel.innerHTML='<option value="">‚Äî Tutti ‚Äî</option>'+ns.map(n=>`<option value="${n.name}" ${n.name===prev?'selected':''}>${n.name} (${curSymbol(n.valuta||'EUR')})</option>`).join('');
  sel.className='entity-select'+(prev?' active-sel':'');
}
function onC1Change(val,c2val,c3val){
  const v=val||document.getElementById('selC1').value;
  const subs=[...(c2Map[v]||[])].sort((a,b)=>a.localeCompare(b,'it'));
  const s2=document.getElementById('selC2');
  s2.innerHTML='<option value="">‚Äî Cat.2 ‚Äî</option>'+subs.map(s=>`<option value="${s}" ${s===c2val?'selected':''}>${s}</option>`).join('');
  s2.disabled=subs.length===0; onC2Change(v,c3val);
}
function onC2Change(c1val,c3val){
  const v1=c1val||document.getElementById('selC1').value, v2=document.getElementById('selC2').value;
  const subs=[...(c3Map[c3k(v1,v2)]||[])].sort((a,b)=>a.localeCompare(b,'it'));
  const s3=document.getElementById('selC3');
  s3.innerHTML='<option value="">‚Äî Cat.3 ‚Äî</option>'+subs.map(s=>`<option value="${s}" ${s===c3val?'selected':''}>${s}</option>`).join('');
  s3.disabled=subs.length===0;
}
function onEntitySelChange(){ entityFilter=document.getElementById('entitySel').value; document.getElementById('entitySel').className='entity-select'+(entityFilter?' active-sel':''); updateEntityBanner();updateFilterBadge();render(); }
function clearEntityFilter(){ entityFilter=''; document.getElementById('entitySel').value=''; document.getElementById('entitySel').className='entity-select'; updateEntityBanner();updateFilterBadge();render(); }
function filterByEntity(name){ entityFilter=name; document.getElementById('entitySel').value=name; document.getElementById('entitySel').className='entity-select active-sel'; updateEntityBanner();updateFilterBadge(); if(!filterOpen)toggleFilterPanel(); render(); }
function updateEntityBanner(){ const b=document.getElementById('entityBanner'); if(entityFilter){ b.classList.add('active'); const no=nomi.find(x=>x.name===entityFilter); document.getElementById('entityBannerLabel').textContent=`Movimenti: ${entityFilter}${no&&no.tipo?' ['+no.tipo+']':''}${no?' ('+curSymbol(no.valuta||'EUR')+')':''}`; } else b.classList.remove('active'); }

// ‚îÄ‚îÄ FX FORM LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onFromChange(){
  updateFxRow();
}
function onToChange(){
  updateFxRow();
}
function updateFxRow(){
  const fromName = document.getElementById('selFrom').value;
  const toName   = document.getElementById('selTo').value;
  if(!fromName||!toName){ document.getElementById('fxRow').style.display='none'; document.getElementById('curFromBadge').textContent=''; return; }
  const curFrom = getNomeValuta(fromName);
  const curTo   = getNomeValuta(toName);
  document.getElementById('curFromBadge').textContent = curSymbol(curFrom);
  if(curFrom!==curTo){
    document.getElementById('fxRow').style.display='flex';
    document.getElementById('fxFromLabel').textContent = `${fmtAmt(parseFloat(document.getElementById('importo').value)||0, curFrom)}`;
    document.getElementById('curToBadge').textContent = curSymbol(curTo);
    // Auto-fill tasso if not manually set
    const tassoEl = document.getElementById('tassoFX');
    if(!tassoEl.dataset.manual){
      const rate = getRate(curFrom, curTo);
      tassoEl.value = rate.toFixed(4);
      document.getElementById('fxRateBadge').textContent = `1 ${curFrom} = ${rate.toFixed(4)} ${curTo}`;
      // Auto-calc importoTo
      const imp = parseFloat(document.getElementById('importo').value)||0;
      if(imp>0){ document.getElementById('importoTo').value = (imp*rate).toFixed(2); }
    }
  } else {
    document.getElementById('fxRow').style.display='none';
  }
}
function onImportoChange(){
  const fromName = document.getElementById('selFrom').value;
  const toName   = document.getElementById('selTo').value;
  if(!fromName||!toName)return;
  const curFrom=getNomeValuta(fromName), curTo=getNomeValuta(toName);
  if(curFrom===curTo)return;
  const imp = parseFloat(document.getElementById('importo').value)||0;
  document.getElementById('fxFromLabel').textContent = `${fmtAmt(imp, curFrom)}`;
  const tasso = parseFloat(document.getElementById('tassoFX').value)||getRate(curFrom,curTo);
  document.getElementById('importoTo').value = (imp*tasso).toFixed(2);
}
function onImportoToChange(){
  const imp = parseFloat(document.getElementById('importo').value)||0;
  const impTo = parseFloat(document.getElementById('importoTo').value)||0;
  if(imp>0&&impTo>0){
    const rate=(impTo/imp);
    document.getElementById('tassoFX').value=rate.toFixed(4);
    document.getElementById('fxRateBadge').textContent=`1 ${getNomeValuta(document.getElementById('selFrom').value)} = ${rate.toFixed(4)} ${getNomeValuta(document.getElementById('selTo').value)}`;
  }
}
function onTassoChange(){
  const tassoEl=document.getElementById('tassoFX');
  tassoEl.dataset.manual='1';
  const imp=parseFloat(document.getElementById('importo').value)||0;
  const tasso=parseFloat(tassoEl.value)||0;
  if(imp>0&&tasso>0){ document.getElementById('importoTo').value=(imp*tasso).toFixed(2); }
  const fromName=document.getElementById('selFrom').value, toName=document.getElementById('selTo').value;
  const curFrom=getNomeValuta(fromName), curTo=getNomeValuta(toName);
  document.getElementById('fxRateBadge').textContent=`1 ${curFrom} = ${tasso.toFixed(4)} ${curTo}`;
}

// ‚îÄ‚îÄ DROPDOWN REBUILD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rebuildDD(){
  const vc1=fC1.size>0?[...fC1]:c1;
  document.getElementById('ddC1').innerHTML=c1.length===0?'<div class="dropdown-empty">Nessuna</div>':c1.map(c=>`<label class="dropdown-item di-c1"><input type="checkbox" ${fC1.has(c)?'checked':''} onchange="toggleF('c1','${c}',this.checked)">${c}</label>`).join('');
  updTr('trC1',fC1,'Tutte cat.1','af-c1');
  const ac2=[...new Set(vc1.flatMap(c=>c2Map[c]||[]))];
  document.getElementById('ddC2').innerHTML=ac2.length===0?'<div class="dropdown-empty">Nessuna</div>':ac2.map(s=>`<label class="dropdown-item di-c2"><input type="checkbox" ${fC2.has(s)?'checked':''} onchange="toggleF('c2','${s}',this.checked)">${s}</label>`).join('');
  updTr('trC2',fC2,'Tutte cat.2','af-c2');
  const vc2=fC2.size>0?[...fC2]:ac2, ac3=[...new Set(vc1.flatMap(a=>vc2.flatMap(b=>c3Map[c3k(a,b)]||[])))];
  document.getElementById('ddC3').innerHTML=ac3.length===0?'<div class="dropdown-empty">Nessuna</div>':ac3.map(s=>`<label class="dropdown-item di-c3"><input type="checkbox" ${fC3.has(s)?'checked':''} onchange="toggleF('c3','${s}',this.checked)">${s}</label>`).join('');
  updTr('trC3',fC3,'Tutte cat.3','af-c3');
}
function updTr(id,set,def,cls){ const el=document.getElementById(id); el.className='mst'; if(set.size>0){el.textContent=[...set].join(', ');el.classList.add(cls);}else el.textContent=def; }
function toggleF(type,val,checked){
  const map={c1:fC1,c2:fC2,c3:fC3}; checked?map[type].add(val):map[type].delete(val);
  if(type==='c1'){const vc1=fC1.size>0?[...fC1]:c1;const ac2=new Set(vc1.flatMap(c=>c2Map[c]||[]));for(const v of [...fC2])if(!ac2.has(v))fC2.delete(v);}
  if(type==='c2'){const vc1=fC1.size>0?[...fC1]:c1;const vc2=fC2.size>0?[...fC2]:[...new Set(vc1.flatMap(c=>c2Map[c]||[]))];const ac3=new Set(vc1.flatMap(a=>vc2.flatMap(b=>c3Map[c3k(a,b)]||[])));for(const v of [...fC3])if(!ac3.has(v))fC3.delete(v);}
  rebuildDD();updateFilterBadge();render();
}

// ‚îÄ‚îÄ RENDER REGISTRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  renderSummary();
  const tbody=document.getElementById('tbody'), filtered=getSorted(getFiltered());
  if(!filtered.length){ tbody.innerHTML=`<tr><td colspan="9" class="empty">Nessun movimento</td></tr>`; return; }
  const nomeOpts=nomi.map(n=>`<option value="${n.name}">${n.name}</option>`).join('');
  const c1Opts=c1.map(c=>`<option value="${c}">${c}</option>`).join('');
  let html='';
  filtered.forEach((r,i)=>{
    const isEx=isExchangeRow(r);
    const df=fmtDate(r.data);
    const cur=r.valuta||'EUR', curTo=r.valutaTo||cur;
    const fromTipo=getTipoNome(r.from), toTipo=getTipoNome(r.to);
    let signHtml='';
    if(entityFilter){
      if(r.to===entityFilter) signHtml=`<span class="amount-pos">+ ${fmtAmt(isEx&&r.valutaTo?r.importoTo||r.importo:r.importo,isEx&&r.valutaTo?r.valutaTo:cur)}</span>`;
      else signHtml=`<span class="amount-neg">- ${fmtAmt(r.importo,cur)}</span>`;
    }
    const valHtml=isEx
      ? `<span class="${curClass(cur)}">${curSymbol(cur)}</span> <span style="color:var(--text3);font-size:10px;">‚Üí</span> <span class="${curClass(curTo)}">${curSymbol(curTo)}</span> <span class="fx-tag">FX</span>`
      : `<span class="${curClass(cur)}">${curSymbol(cur)}</span>`;
    if(editingIdx===i){
      const rc2=(c2Map[r.c1]||[]).map(s=>`<option value="${s}" ${s===r.c2?'selected':''}>${s}</option>`).join('');
      const rc3=(c3Map[c3k(r.c1,r.c2)]||[]).map(s=>`<option value="${s}" ${s===r.c3?'selected':''}>${s}</option>`).join('');
      html+=`<tr class="editing">
        <td><input class="edit-input" id="ed-data" type="date" value="${r.data}"></td>
        <td><select class="edit-select" id="ed-from">${nomeOpts}</select></td>
        <td><select class="edit-select" id="ed-to">${nomeOpts}</select></td>
        <td><input class="edit-input" id="ed-desc" type="text" value="${r.desc}"></td>
        <td><select class="edit-select" id="ed-c1" onchange="edC1Change(this.value)">${c1Opts}</select></td>
        <td><input class="edit-input" id="ed-imp" type="number" value="${r.importo}"> ${isEx?`<br><small>‚Üí <input class="edit-input" id="ed-impto" type="number" value="${r.importoTo||''}" style="width:70px"> ${curSymbol(curTo)}</small>`:''}</td>
        <td>${valHtml}</td>
        <td>‚Äî</td>
        <td><div class="row-actions"><button class="btn-save" onclick="saveEdit(${i})">‚úî</button><button class="btn-cancel" onclick="cancelEdit()">‚úï</button></div></td>
      </tr>`;
      setTimeout(()=>{
        const ef=document.getElementById('ed-from'); if(ef) for(let o of ef.options) if(o.value===r.from)o.selected=true;
        const et=document.getElementById('ed-to'); if(et) for(let o of et.options) if(o.value===r.to)o.selected=true;
        const ec=document.getElementById('ed-c1'); if(ec) for(let o of ec.options) if(o.value===r.c1)o.selected=true;
      },0);
    } else {
      const importoDisplay = isEx
        ? `${fmtAmt(r.importo,cur)}<br><small style="color:#e67e22;">‚Üí ${fmtAmt(r.importoTo||0,curTo)}</small>`
        : fmtAmt(r.importo,cur);
      html+=`<tr ${isEx?'class="exchange-row"':''}>
        <td>${df}</td>
        <td><span class="badge-name badge-from" onclick="filterByEntity('${r.from}')">${r.from}</span>${fromTipo?`<span class="tipo-tag">${fromTipo}</span>`:''}</td>
        <td><span class="badge-name badge-to" onclick="filterByEntity('${r.to}')">${r.to}</span>${toTipo?`<span class="tipo-tag">${toTipo}</span>`:''}</td>
        <td>${r.desc}</td>
        <td><span class="c1-badge">${r.c1||'‚Äî'}</span></td>
        <td class="amount-neu">${importoDisplay}</td>
        <td>${valHtml}</td>
        <td>${signHtml}</td>
        <td><div class="row-actions"><button class="btn-edit" onclick="startEdit(${i})">‚úèÔ∏è</button><button class="btn-del" onclick="elimina(${i})">üóë</button></div></td>
      </tr>`;
    }
  });
  tbody.innerHTML=html;
}

// ‚îÄ‚îÄ CRUD REGISTRO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function aggiungi(){
  const data=document.getElementById('data').value;
  const fromName=document.getElementById('selFrom').value, toName=document.getElementById('selTo').value;
  const desc=document.getElementById('descrizione').value.trim();
  const c1v=document.getElementById('selC1').value||'-', c2v=document.getElementById('selC2').value||'-', c3v=document.getElementById('selC3').value||'-';
  const importo=parseFloat(document.getElementById('importo').value);
  if(!data||!fromName||!toName||!desc||isNaN(importo)||importo<=0){alert('Compila tutti i campi');return;}
  if(fromName===toName){alert('From = To non valido');return;}
  const curFrom=getNomeValuta(fromName), curTo=getNomeValuta(toName);
  const isEx = curFrom!==curTo;
  const row = { data, from:fromName, to:toName, desc, c1:c1v, c2:c2v, c3:c3v, importo, valuta:curFrom };
  if(isEx){
    row.isExchange=true;
    row.valutaTo=curTo;
    row.importoTo=parseFloat(document.getElementById('importoTo').value)||0;
    row.tassoFX=parseFloat(document.getElementById('tassoFX').value)||getRate(curFrom,curTo);
  }
  rows.push(row);
  rows.sort((a,b)=>a.data.localeCompare(b.data));
  document.getElementById('descrizione').value='';
  document.getElementById('importo').value='';
  document.getElementById('importoTo').value='';
  document.getElementById('tassoFX').value='';
  delete document.getElementById('tassoFX').dataset.manual;
  document.getElementById('fxRow').style.display='none';
  await saveToFirebase(); render();
}
function startEdit(i){editingIdx=i;render();}
function cancelEdit(){editingIdx=null;render();}
async function saveEdit(i){
  const fi=getFiltered(), orig=rows.indexOf(fi[i]), r=rows[orig];
  r.data=document.getElementById('ed-data').value||r.data;
  r.from=document.getElementById('ed-from').value||r.from;
  r.to=document.getElementById('ed-to').value||r.to;
  r.desc=document.getElementById('ed-desc').value||r.desc;
  r.c1=document.getElementById('ed-c1').value||r.c1;
  r.importo=parseFloat(document.getElementById('ed-imp').value)||r.importo;
  r.valuta=getNomeValuta(r.from);
  if(isExchangeRow(r)){
    const el=document.getElementById('ed-impto');
    if(el) r.importoTo=parseFloat(el.value)||r.importoTo;
  }
  rows.sort((a,b)=>a.data.localeCompare(b.data)); editingIdx=null;
  await saveToFirebase(); render();
}
async function elimina(i){ if(!confirm('Eliminare?'))return; rows.splice(rows.indexOf(getFiltered()[i]),1); await saveToFirebase(); render(); }
function edC1Change(v){ const s=document.getElementById('ed-c2'); const subs=c2Map[v]||[]; s.innerHTML='<option value="-">‚Äî</option>'+subs.map(x=>`<option value="${x}">${x}</option>`).join(''); document.getElementById('ed-c3').innerHTML='<option value="-">‚Äî</option>'; }

// ‚îÄ‚îÄ NOMI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addNome(){
  const ni=document.getElementById('inputNome'), ti=document.getElementById('inputNomeTipo'), vi=document.getElementById('inputNomeVal');
  const v=ni.value.trim(), tipo=ti.value.trim(), valuta=vi.value||'EUR';
  if(!v)return; if(nomi.find(x=>x.name===v)){alert('Gi√† presente');return;}
  nomi.push({name:v,tipo,valuta}); ni.value=''; ti.value='';
  await saveToFirebase(); renderNomiPage();syncSelects();syncTipoSel();rebuildDD();
}
async function delNome(n){
  if(rows.some(r=>r.from===n||r.to===n)) if(!confirm(`Eliminare "${n}"?`))return;
  nomi=nomi.filter(x=>x.name!==n); if(entityFilter===n)entityFilter='';
  await saveToFirebase(); renderNomiPage();syncSelects();syncEntitySel();syncTipoSel();render();
}
function startEditNome(idx){ editingNomeIdx=idx; renderNomiPage(); }
function cancelEditNome(){ editingNomeIdx=null; renderNomiPage(); }
async function saveEditNome(idx){
  const nv=document.getElementById('en-name-'+idx).value.trim();
  const nt=document.getElementById('en-tipo-'+idx).value.trim();
  const nval=document.getElementById('en-val-'+idx).value||'EUR';
  if(!nv){alert('Nome vuoto');return;}
  const oldName=nomi[idx].name;
  rows.forEach(r=>{ if(r.from===oldName){r.from=nv;r.valuta=nval;} if(r.to===oldName){r.to=nv;if(r.isExchange)r.valutaTo=nval;} });
  if(entityFilter===oldName)entityFilter=nv;
  nomi[idx]={name:nv,tipo:nt,valuta:nval};
  editingNomeIdx=null;
  await saveToFirebase(); renderNomiPage();syncSelects();syncEntitySel();syncTipoSel();render();
}
function renderNomiPage(){
  const tbody=document.getElementById('nomiTbody');
  const ns=[...nomi].sort((a,b)=>a.name.localeCompare(b.name,'it'));
  if(!ns.length){ tbody.innerHTML=`<tr><td colspan="4" class="empty-tag" style="padding:14px 10px;">Nessun nome.</td></tr>`; return; }
  tbody.innerHTML=ns.map(n=>{
    const origIdx=nomi.indexOf(n);
    if(editingNomeIdx===origIdx) return `<tr>
      <td><input class="nome-edit-input" id="en-name-${origIdx}" value="${n.name}"></td>
      <td><input class="nome-edit-tipo" id="en-tipo-${origIdx}" value="${n.tipo||''}" placeholder="Tipo..." list="tipoSuggest"></td>
      <td><select class="nome-edit-val" id="en-val-${origIdx}">
        <option value="EUR" ${(n.valuta||'EUR')==='EUR'?'selected':''}>‚Ç¨ Euro</option>
        <option value="GBP" ${n.valuta==='GBP'?'selected':''}>¬£ Sterlina</option>
        <option value="AED" ${n.valuta==='AED'?'selected':''}>AED Dirham</option>
      </select></td>
      <td style="white-space:nowrap"><button class="btn-nome-save" onclick="saveEditNome(${origIdx})">‚úî</button><button class="btn-nome-cancel" onclick="cancelEditNome()">‚úï</button></td></tr>`;
    return `<tr>
      <td><strong>${n.name}</strong></td>
      <td>${n.tipo?`<span class="nome-tipo-badge">${n.tipo}</span>`:'<span class="nome-tipo-empty">‚Äî</span>'}</td>
      <td><span class="${curClass(n.valuta||'EUR')}">${curSymbol(n.valuta||'EUR')}</span></td>
      <td style="white-space:nowrap"><button class="btn-nome-edit" onclick="startEditNome(${origIdx})">‚úèÔ∏è</button><button class="btn-nome-del" onclick="delNome('${n.name}')">üóë</button></td></tr>`;
  }).join('');
  document.getElementById('tipoSuggest').innerHTML=getTipi().map(t=>`<option value="${t}">`).join('');
}

// ‚îÄ‚îÄ CATEGORIE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function addC1(){ const i=document.getElementById('inputC1'),v=i.value.trim(); if(!v)return; if(c1.includes(v)){alert('Presente');return;} c1.push(v);if(!c2Map[v])c2Map[v]=[];i.value=''; await saveToFirebase(); renderC1Page();syncSelects();syncParentSelects();rebuildDD(); }
async function delC1(c){ if(rows.some(r=>r.c1===c))if(!confirm(`Eliminare "${c}"?`))return; c1=c1.filter(x=>x!==c);delete c2Map[c];fC1.delete(c); await saveToFirebase(); renderC1Page();syncSelects();syncParentSelects();rebuildDD();render(); }
function renderC1Page(){ document.getElementById('c1List').innerHTML=c1.length===0?'<span class="empty-tag">Nessuna</span>':c1.map(c=>`<div class="tag-item c1">${c}<span class="del-tag" onclick="delC1('${c}')">√ó</span></div>`).join(''); }
async function addC2(){ const par=document.getElementById('c1ForC2').value; if(!par){alert('Seleziona Cat.1');return;} const i=document.getElementById('inputC2'),v=i.value.trim(); if(!v)return; if((c2Map[par]||[]).includes(v)){alert('Presente');return;} if(!c2Map[par])c2Map[par]=[]; c2Map[par].push(v);i.value=''; await saveToFirebase(); renderC2Page();syncSelects();syncC2ForC3();rebuildDD(); }
async function delC2(par,c){ c2Map[par]=(c2Map[par]||[]).filter(x=>x!==c);fC2.delete(c); await saveToFirebase(); renderC2Page();syncSelects();syncC2ForC3();rebuildDD();render(); }
function renderC2Page(){ const par=document.getElementById('c1ForC2').value,sec=document.getElementById('c2Section'),row=document.getElementById('c2AddRow'); if(!par){sec.innerHTML='<span class="empty-tag">Seleziona Cat.1</span>';row.style.display='none';return;} row.style.display='flex'; const subs=c2Map[par]||[]; sec.innerHTML=`<div class="sub-title c1">Sottocategorie di: ${par}</div>`+(subs.length===0?'<span class="empty-tag">Nessuna</span>':`<div class="tag-list">${subs.map(s=>`<div class="tag-item c2">${s}<span class="del-tag" onclick="delC2('${par}','${s}')">√ó</span></div>`).join('')}</div>`); }
function syncC2ForC3(){ const v=document.getElementById('c1ForC3').value,sel=document.getElementById('c2ForC3'),prev=sel.value; sel.innerHTML='<option value="">‚Äî Seleziona ‚Äî</option>'+(c2Map[v]||[]).map(c=>`<option value="${c}" ${c===prev?'selected':''}>${c}</option>`).join(''); }
async function addC3(){ const c1v=document.getElementById('c1ForC3').value,c2v=document.getElementById('c2ForC3').value; if(!c1v||!c2v){alert('Seleziona Cat.1 e Cat.2');return;} const k=c3k(c1v,c2v),i=document.getElementById('inputC3'),v=i.value.trim(); if(!v)return; if((c3Map[k]||[]).includes(v)){alert('Presente');return;} if(!c3Map[k])c3Map[k]=[]; c3Map[k].push(v);i.value=''; await saveToFirebase(); renderC3Page();syncSelects();rebuildDD(); }
async function delC3(c1v,c2v,c){ const k=c3k(c1v,c2v); c3Map[k]=(c3Map[k]||[]).filter(x=>x!==c);fC3.delete(c); await saveToFirebase(); renderC3Page();syncSelects();rebuildDD();render(); }
function renderC3Page(){ const c1v=document.getElementById('c1ForC3').value,c2v=document.getElementById('c2ForC3').value,sec=document.getElementById('c3Section'),row=document.getElementById('c3AddRow'); if(!c1v||!c2v){sec.innerHTML='<span class="empty-tag">Seleziona Cat.1 e Cat.2</span>';row.style.display='none';return;} row.style.display='flex'; const subs=c3Map[c3k(c1v,c2v)]||[]; sec.innerHTML=`<div class="sub-title c2">Sottocategorie: ${c1v} ‚Ä∫ ${c2v}</div>`+(subs.length===0?'<span class="empty-tag">Nessuna</span>':`<div class="tag-list">${subs.map(s=>`<div class="tag-item c3">${s}<span class="del-tag" onclick="delC3('${c1v}','${c2v}','${s}')">√ó</span></div>`).join('')}</div>`); }
function syncParentSelects(){ ['c1ForC2','c1ForC3'].forEach(id=>{ const sel=document.getElementById(id),prev=sel.value; sel.innerHTML='<option value="">‚Äî Seleziona ‚Äî</option>'+c1.map(c=>`<option value="${c}" ${c===prev?'selected':''}>${c}</option>`).join(''); }); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function syncReportSelects(){
  const re=document.getElementById('rptEntity'),prev=re.value;
  re.innerHTML='<option value="">‚Äî Seleziona ‚Äî</option>'+nomi.map(n=>`<option value="${n.name}" ${n.name===prev?'selected':''}>${n.name} (${curSymbol(n.valuta||'EUR')})${n.tipo?' ['+n.tipo+']':''}</option>`).join('');
  const rc=document.getElementById('rptC1'),prevc=rc.value;
  rc.innerHTML='<option value="">‚Äî Tutte ‚Äî</option>'+c1.map(c=>`<option value="${c}" ${c===prevc?'selected':''}>${c}</option>`).join('');
  const rt=document.getElementById('rptTipoSel'),prevt=rt.value;
  rt.innerHTML='<option value="">‚Äî Tutti ‚Äî</option>'+getTipi().map(t=>`<option value="${t}" ${t===prevt?'selected':''}>${t}</option>`).join('');
}

function onRptTypeChange(){
  const t=document.getElementById('rptType').value;
  ['Estrato','Categoria','Tipo','Date','Saldo','Fx'].forEach(x=>{ const el=document.getElementById('rptParam'+x); if(el)el.style.display='none'; });
  const map={estratto:'Estrato',categoria:'Categoria',tipo:'Tipo',date:'Date',saldo:'Saldo',fx:'Fx'};
  const el=document.getElementById('rptParam'+map[t]); if(el)el.style.display='block';
}

function newReport(){
  activeReportIdx=null;
  document.getElementById('rptName').value='';
  document.getElementById('rptType').value='estratto';
  onRptTypeChange();
  ['rptFrom','rptTo','rptFromCat','rptToCat','rptFromTipo','rptToTipo','rptFromDate','rptToDate','rptFromSaldo','rptToSaldo','rptFromFx','rptToFx'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value=''; });
  document.getElementById('reportOutput').style.display='none';
  document.querySelectorAll('.report-saved-item').forEach(x=>x.classList.remove('active'));
}

function loadReport(idx){
  activeReportIdx=idx; const r=savedReports[idx];
  document.getElementById('rptName').value=r.name;
  document.getElementById('rptType').value=r.type;
  onRptTypeChange();
  const p=r.params||{};
  if(r.type==='estratto'){ document.getElementById('rptEntity').value=p.entity||''; document.getElementById('rptFrom').value=p.from||''; document.getElementById('rptTo').value=p.to||''; }
  if(r.type==='categoria'){ document.getElementById('rptC1').value=p.c1v||''; document.getElementById('rptFromCat').value=p.from||''; document.getElementById('rptToCat').value=p.to||''; }
  if(r.type==='tipo'){ document.getElementById('rptTipoSel').value=p.tipo||''; document.getElementById('rptFromTipo').value=p.from||''; document.getElementById('rptToTipo').value=p.to||''; }
  if(r.type==='date'){ document.getElementById('rptFromDate').value=p.from||''; document.getElementById('rptToDate').value=p.to||''; }
  if(r.type==='saldo'){ document.getElementById('rptFromSaldo').value=p.from||''; document.getElementById('rptToSaldo').value=p.to||''; }
  if(r.type==='fx'){ document.getElementById('rptFromFx').value=p.from||''; document.getElementById('rptToFx').value=p.to||''; }
  document.querySelectorAll('.report-saved-item').forEach((x,i)=>x.classList.toggle('active',i===idx));
  runReport();
}

function getReportConfig(){
  const type=document.getElementById('rptType').value; let params={};
  if(type==='estratto') params={entity:document.getElementById('rptEntity').value, from:document.getElementById('rptFrom').value, to:document.getElementById('rptTo').value};
  if(type==='categoria') params={c1v:document.getElementById('rptC1').value, from:document.getElementById('rptFromCat').value, to:document.getElementById('rptToCat').value};
  if(type==='tipo') params={tipo:document.getElementById('rptTipoSel').value, from:document.getElementById('rptFromTipo').value, to:document.getElementById('rptToTipo').value};
  if(type==='date') params={from:document.getElementById('rptFromDate').value, to:document.getElementById('rptToDate').value};
  if(type==='saldo') params={from:document.getElementById('rptFromSaldo').value, to:document.getElementById('rptToSaldo').value};
  if(type==='fx') params={from:document.getElementById('rptFromFx').value, to:document.getElementById('rptToFx').value};
  return {type,params};
}

function filterRows(from,to,extra){
  return rows.filter(r=>{ if(from&&r.data<from)return false; if(to&&r.data>to)return false; if(extra&&!extra(r))return false; return true; }).sort((a,b)=>a.data.localeCompare(b.data));
}

function runReport(){
  const {type,params}=getReportConfig();
  const out=document.getElementById('reportOutput');
  const outTitle=document.getElementById('rptOutTitle');
  const outMeta=document.getElementById('rptOutMeta');
  const outBody=document.getElementById('rptOutBody');
  out.style.display='block';
  const typeLabels={estratto:'Estratto Conto',categoria:'Per Categoria',tipo:'Per Tipo',date:'Per Periodo',saldo:'Saldo Entit√†',fx:'Exchange FX'};
  const typeBadge={estratto:'rtb-estratto',categoria:'rtb-categoria',tipo:'rtb-tipo',date:'rtb-date',saldo:'rtb-saldo',fx:'rtb-fx'};
  const name=document.getElementById('rptName').value||typeLabels[type];
  outTitle.innerHTML=`${name} <span class="report-type-badge ${typeBadge[type]}">${typeLabels[type]}</span>`;
  if(type==='estratto') renderEstrattoReport(params,outMeta,outBody);
  else if(type==='categoria') renderCategoriaReport(params,outMeta,outBody);
  else if(type==='tipo') renderTipoReport(params,outMeta,outBody);
  else if(type==='date') renderDateReport(params,outMeta,outBody);
  else if(type==='saldo') renderSaldoReport(params,outMeta,outBody);
  else if(type==='fx') renderFxReport(params,outMeta,outBody);
}

// ‚îÄ‚îÄ REPORT: ESTRATTO CONTO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderEstrattoReport(params,metaEl,bodyEl){
  const {entity,from,to}=params;
  if(!entity){bodyEl.innerHTML='<div class="report-no-data">Seleziona un\'entit√†</div>';metaEl.textContent='';return;}
  const data=filterRows(from,to,r=>r.from===entity||r.to===entity);
  const no=nomi.find(x=>x.name===entity);
  const entityCur=no?no.valuta||'EUR':'EUR';
  metaEl.textContent=`${entity} (${curSymbol(entityCur)})${no&&no.tipo?' ¬∑ '+no.tipo:''}${(from||to)?' ¬∑ '+fmtDate(from)+'‚Üí'+fmtDate(to):''} ¬∑ ${data.length} mov.`;
  if(!data.length){bodyEl.innerHTML='<div class="report-no-data">Nessun movimento</div>';return;}
  let saldoProg=0,totE=0,totU=0;
  let html=`<table class="report-table"><thead><tr>
    <th>Data</th><th>Controparte</th><th>Descrizione</th><th>Cat.1</th>
    <th class="td-num">Entrata</th><th class="td-num">Uscita</th><th class="td-num">Saldo Prog.</th><th>Valuta</th>
  </tr></thead><tbody>`;
  data.forEach(r=>{
    let entrata=0,uscita=0,controparte='';
    const cur=r.valuta||'EUR';
    const isEx=isExchangeRow(r);
    if(r.to===entity){
      entrata=isEx?r.importoTo||r.importo:r.importo;
      const ec=isEx?r.valutaTo||cur:cur;
      controparte=r.from; totE+=entrata; saldoProg+=entrata;
      const sp=saldoProg>=0?'pos':'neg';
      html+=`<tr><td>${fmtDate(r.data)}</td><td><strong>${controparte}</strong></td><td>${r.desc}${isEx?` <span class="fx-tag">FX</span>`:''}</td><td><span class="c1-badge">${r.c1||'‚Äî'}</span></td><td class="td-num pos">${fmtAmt(entrata,ec)}</td><td></td><td class="td-num ${sp}">${fmtAmt(saldoProg,entityCur)}</td><td><span class="${curClass(ec)}">${curSymbol(ec)}</span></td></tr>`;
    } else {
      uscita=r.importo; controparte=r.to; totU+=uscita; saldoProg-=uscita;
      const sp=saldoProg>=0?'pos':'neg';
      html+=`<tr><td>${fmtDate(r.data)}</td><td><strong>${controparte}</strong></td><td>${r.desc}${isEx?` <span class="fx-tag">FX</span>`:''}</td><td><span class="c1-badge">${r.c1||'‚Äî'}</span></td><td></td><td class="td-num neg">${fmtAmt(uscita,cur)}</td><td class="td-num ${sp}">${fmtAmt(saldoProg,entityCur)}</td><td><span class="${curClass(cur)}">${curSymbol(cur)}</span></td></tr>`;
    }
  });
  html+=`</tbody><tfoot><tr><td colspan="4"><strong>TOTALE (${curSymbol(entityCur)})</strong></td><td class="td-num pos"><strong>${fmtAmt(totE,entityCur)}</strong></td><td class="td-num neg"><strong>${fmtAmt(totU,entityCur)}</strong></td><td class="td-num ${saldoProg>=0?'pos':'neg'}"><strong>${fmtAmt(saldoProg,entityCur)}</strong></td><td></td></tr></tfoot></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ REPORT: CATEGORIA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCategoriaReport(params,metaEl,bodyEl){
  const {c1v,from,to}=params;
  const data=filterRows(from,to,r=>!c1v||(r.c1===c1v));
  metaEl.textContent=`${c1v||'Tutte le categorie'} ¬∑ ${(from||to)?fmtDate(from)+'‚Üí'+fmtDate(to):'Tutti'} ¬∑ ${data.length} mov.`;
  if(!data.length){bodyEl.innerHTML='<div class="report-no-data">Nessun movimento</div>';return;}

  // Group by currency first, then c1‚Üíc2
  const byCur={};
  data.forEach(r=>{
    const cur=r.valuta||'EUR', k1=r.c1||'‚Äî', k2=r.c2||'‚Äî';
    if(!byCur[cur]) byCur[cur]={};
    if(!byCur[cur][k1]) byCur[cur][k1]={tot:0,subs:{}};
    if(!byCur[cur][k1].subs[k2]) byCur[cur][k1].subs[k2]=0;
    byCur[cur][k1].tot+=r.importo;
    byCur[cur][k1].subs[k2]+=r.importo;
  });

  let html=`<table class="report-table"><thead><tr><th>Cat.1</th><th>Cat.2</th><th class="td-num">Importo</th><th class="td-num">% su valuta</th></tr></thead><tbody>`;
  Object.keys(byCur).sort().forEach(cur=>{
    const totCur=Object.values(byCur[cur]).reduce((s,g)=>s+g.tot,0);
    html+=`<tr class="cur-section-header"><td colspan="4">üí± ${curSymbol(cur)} ${cur} ‚Äî Totale: <strong>${fmtAmt(totCur,cur)}</strong></td></tr>`;
    Object.keys(byCur[cur]).sort().forEach(k1=>{
      const g=byCur[cur][k1];
      html+=`<tr class="report-section-header"><td colspan="4"><strong>üü£ ${k1}</strong></td></tr>`;
      Object.keys(g.subs).sort().forEach(k2=>{
        const v=g.subs[k2], pct=totCur>0?(v/totCur*100).toFixed(1):'0';
        html+=`<tr><td></td><td><span class="c2-badge">${k2}</span></td><td class="td-num">${fmtAmt(v,cur)}</td><td class="td-num" style="color:var(--text3)">${pct}%</td></tr>`;
      });
      html+=`<tr style="background:var(--surface2);"><td></td><td style="font-size:11px;font-weight:bold;color:var(--text2);">‚Ü≥ Subtot. ${k1}</td><td class="td-num"><strong>${fmtAmt(g.tot,cur)}</strong></td><td class="td-num" style="color:var(--text3)">${totCur>0?(g.tot/totCur*100).toFixed(1):0}%</td></tr>`;
    });
  });
  html+=`</tbody></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ REPORT: TIPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTipoReport(params,metaEl,bodyEl){
  const {tipo,from,to}=params;
  const data=filterRows(from,to);
  metaEl.textContent=`${tipo||'Tutti i tipi'} ¬∑ ${(from||to)?fmtDate(from)+'‚Üí'+fmtDate(to):'Tutti'}`;

  // Group by tipo‚Üíentit√†‚Üícurrency
  const tipiMap={};
  data.forEach(r=>{
    [r.from,r.to].forEach((nome,idx)=>{
      const tn=getTipoNome(nome)||'‚Äî';
      if(tipo&&tn!==tipo)return;
      const cur=getNomeValuta(nome);
      if(!tipiMap[tn])tipiMap[tn]={};
      if(!tipiMap[tn][nome])tipiMap[tn][nome]={entrate:{},uscite:{}};
      if(idx===1){ tipiMap[tn][nome].entrate[cur]=(tipiMap[tn][nome].entrate[cur]||0)+r.importo; }
      else { tipiMap[tn][nome].uscite[cur]=(tipiMap[tn][nome].uscite[cur]||0)+r.importo; }
    });
  });
  if(!Object.keys(tipiMap).length){bodyEl.innerHTML='<div class="report-no-data">Nessun dato</div>';return;}

  let html=`<table class="report-table"><thead><tr><th>Tipo</th><th>Entit√†</th><th class="td-num">Entrate</th><th class="td-num">Uscite</th><th class="td-num">Saldo</th></tr></thead><tbody>`;
  Object.keys(tipiMap).sort().forEach(t=>{
    html+=`<tr class="report-section-header"><td colspan="5"><strong>${t}</strong></td></tr>`;
    Object.keys(tipiMap[t]).sort().forEach(nome=>{
      const e=tipiMap[t][nome];
      const allCurs=[...new Set([...Object.keys(e.entrate),...Object.keys(e.uscite)])];
      allCurs.forEach(cur=>{
        const ei=e.entrate[cur]||0, ui=e.uscite[cur]||0, si=ei-ui;
        html+=`<tr><td></td><td><strong>${nome}</strong> <span class="${curClass(cur)}">${curSymbol(cur)}</span></td><td class="td-num pos">${ei>0?fmtAmt(ei,cur):''}</td><td class="td-num neg">${ui>0?fmtAmt(ui,cur):''}</td><td class="td-num ${si>=0?'pos':'neg'}">${fmtAmt(si,cur)}</td></tr>`;
      });
    });
  });
  html+=`</tbody></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ REPORT: DATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDateReport(params,metaEl,bodyEl){
  const {from,to}=params;
  const data=filterRows(from,to);
  metaEl.textContent=`${(from||to)?fmtDate(from)+'‚Üí'+fmtDate(to):'Tutti'} ¬∑ ${data.length} mov.`;
  if(!data.length){bodyEl.innerHTML='<div class="report-no-data">Nessun movimento</div>';return;}

  // Group by currency
  const byCur={};
  data.forEach(r=>{
    const cur=r.valuta||'EUR';
    if(!byCur[cur])byCur[cur]=[];
    byCur[cur].push(r);
  });

  let html=`<table class="report-table"><thead><tr><th>Data</th><th>From</th><th>To</th><th>Descrizione</th><th>Cat.1</th><th class="td-num">Importo</th><th>Val.</th></tr></thead><tbody>`;
  Object.keys(byCur).sort().forEach(cur=>{
    const arr=byCur[cur], tot=arr.reduce((s,r)=>s+r.importo,0);
    html+=`<tr class="cur-section-header"><td colspan="7">üí± ${curSymbol(cur)} ${cur} ‚Äî ${arr.length} mov. ‚Äî Totale: <strong>${fmtAmt(tot,cur)}</strong></td></tr>`;
    arr.forEach(r=>{
      const isEx=isExchangeRow(r);
      html+=`<tr>
        <td>${fmtDate(r.data)}</td>
        <td><span class="badge-from" style="border-radius:8px;padding:2px 7px;font-size:10px;font-weight:bold;">${r.from}</span></td>
        <td><span class="badge-to" style="border-radius:8px;padding:2px 7px;font-size:10px;font-weight:bold;">${r.to}</span></td>
        <td>${r.desc}${isEx?` <span class="fx-tag">FX</span>`:''}</td>
        <td><span class="c1-badge">${r.c1||'‚Äî'}</span></td>
        <td class="td-num">${fmtAmt(r.importo,cur)}${isEx?`<br><small style="color:#e67e22;">‚Üí ${fmtAmt(r.importoTo||0,r.valutaTo)}</small>`:''}</td>
        <td><span class="${curClass(cur)}">${curSymbol(cur)}</span></td>
      </tr>`;
    });
  });
  html+=`</tbody></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ REPORT: SALDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSaldoReport(params,metaEl,bodyEl){
  const {from,to}=params;
  const data=filterRows(from,to);
  metaEl.textContent=`Confronto saldi ¬∑ ${(from||to)?fmtDate(from)+'‚Üí'+fmtDate(to):'Tutti'}`;
  if(!data.length){bodyEl.innerHTML='<div class="report-no-data">Nessun movimento</div>';return;}

  const saldi={};
  nomi.forEach(n=>{ saldi[n.name]={entrate:{},uscite:{},tipo:n.tipo||'‚Äî',valuta:n.valuta||'EUR'}; });
  data.forEach(r=>{
    const cf=r.valuta||'EUR', ct=r.valutaTo||cf;
    if(!saldi[r.from])saldi[r.from]={entrate:{},uscite:{},tipo:getTipoNome(r.from)||'‚Äî',valuta:cf};
    if(!saldi[r.to])saldi[r.to]={entrate:{},uscite:{},tipo:getTipoNome(r.to)||'‚Äî',valuta:ct};
    saldi[r.from].uscite[cf]=(saldi[r.from].uscite[cf]||0)+r.importo;
    const toAmt=isExchangeRow(r)?r.importoTo||r.importo:r.importo;
    saldi[r.to].entrate[ct]=(saldi[r.to].entrate[ct]||0)+toAmt;
  });

  const perTipo={};
  Object.keys(saldi).forEach(nome=>{ const s=saldi[nome],t=s.tipo; if(!perTipo[t])perTipo[t]=[]; perTipo[t].push({nome,...s}); });

  let html=`<table class="report-table"><thead><tr><th>Tipo</th><th>Entit√†</th><th class="td-num">Entrate</th><th class="td-num">Uscite</th><th class="td-num">Saldo</th></tr></thead><tbody>`;
  Object.keys(perTipo).sort().forEach(tipo=>{
    const items=perTipo[tipo].filter(x=>Object.values(x.entrate).some(v=>v>0)||Object.values(x.uscite).some(v=>v>0)).sort((a,b)=>a.nome.localeCompare(b.nome));
    if(!items.length)return;
    html+=`<tr class="report-section-header"><td colspan="5"><strong>${tipo}</strong></td></tr>`;
    items.forEach(x=>{
      const allCurs=[...new Set([...Object.keys(x.entrate),...Object.keys(x.uscite)])];
      // show native currency first
      const sortedCurs=[x.valuta,...allCurs.filter(c=>c!==x.valuta)];
      sortedCurs.forEach(cur=>{
        const ei=x.entrate[cur]||0, ui=x.uscite[cur]||0;
        if(ei===0&&ui===0)return;
        const si=ei-ui;
        html+=`<tr><td></td><td><strong>${x.nome}</strong> <span class="${curClass(cur)}">${curSymbol(cur)}</span></td><td class="td-num pos">${ei>0?fmtAmt(ei,cur):''}</td><td class="td-num neg">${ui>0?fmtAmt(ui,cur):''}</td><td class="td-num ${si>=0?'pos':'neg'}">${fmtAmt(si,cur)}</td></tr>`;
      });
    });
  });
  html+=`</tbody></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ REPORT: FX EXCHANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFxReport(params,metaEl,bodyEl){
  const {from,to}=params;
  const data=filterRows(from,to,r=>r.isExchange&&r.valutaTo&&r.valutaTo!==r.valuta);
  metaEl.textContent=`Exchange FX ¬∑ ${(from||to)?fmtDate(from)+'‚Üí'+fmtDate(to):'Tutti'} ¬∑ ${data.length} operazioni`;
  if(!data.length){bodyEl.innerHTML='<div class="report-no-data">Nessuna operazione FX trovata</div>';return;}

  let html=`<table class="report-table"><thead><tr>
    <th>Data</th><th>Da Conto</th><th>A Conto</th><th>Descrizione</th>
    <th class="td-num">Importo ceduto</th><th class="td-num">Importo ricevuto</th>
    <th class="td-num">Tasso applicato</th><th class="td-num">Tasso attuale*</th><th class="td-num">Œî%</th>
  </tr></thead><tbody>`;

  let totByCur={};
  data.forEach(r=>{
    const cf=r.valuta||'EUR', ct=r.valutaTo;
    const tassoApplicato=r.tassoFX||( r.importoTo&&r.importo ? r.importoTo/r.importo : getRate(cf,ct) );
    const tassoAttuale=getRate(cf,ct);
    const delta=tassoApplicato>0?((tassoApplicato-tassoAttuale)/tassoApplicato*100):0;
    const deltaClass=delta>=0?'pos':'neg';
    if(!totByCur[cf])totByCur[cf]={ceduto:0,ricevuto:{},valutaTo:ct};
    totByCur[cf].ceduto+=r.importo;
    totByCur[cf].ricevuto[ct]=(totByCur[cf].ricevuto[ct]||0)+(r.importoTo||0);
    html+=`<tr>
      <td>${fmtDate(r.data)}</td>
      <td><span class="badge-from" style="border-radius:8px;padding:2px 7px;font-size:10px;font-weight:bold;">${r.from}</span> <span class="${curClass(cf)}">${curSymbol(cf)}</span></td>
      <td><span class="badge-to" style="border-radius:8px;padding:2px 7px;font-size:10px;font-weight:bold;">${r.to}</span> <span class="${curClass(ct)}">${curSymbol(ct)}</span></td>
      <td>${r.desc}</td>
      <td class="td-num neg">${fmtAmt(r.importo,cf)}</td>
      <td class="td-num pos">${fmtAmt(r.importoTo||0,ct)}</td>
      <td class="td-num" style="font-family:monospace;">1 ${curSymbol(cf)} = ${tassoApplicato.toFixed(4)} ${curSymbol(ct)}</td>
      <td class="td-num" style="font-family:monospace;color:var(--text3);">1 ${curSymbol(cf)} = ${tassoAttuale.toFixed(4)} ${curSymbol(ct)}</td>
      <td class="td-num ${deltaClass}">${delta>=0?'+':''}${delta.toFixed(2)}%</td>
    </tr>`;
  });

  html+=`</tbody><tfoot>`;
  Object.keys(totByCur).forEach(cf=>{
    const t=totByCur[cf];
    Object.keys(t.ricevuto).forEach(ct=>{
      html+=`<tr><td colspan="4"><strong>Totale ${curSymbol(cf)}‚Üí${curSymbol(ct)}</strong></td><td class="td-num neg"><strong>${fmtAmt(t.ceduto,cf)}</strong></td><td class="td-num pos"><strong>${fmtAmt(t.ricevuto[ct],ct)}</strong></td><td colspan="3"><small style="color:var(--text3)">*tasso corrente via API</small></td></tr>`;
    });
  });
  html+=`</tfoot></table>`;
  bodyEl.innerHTML=html;
}

// ‚îÄ‚îÄ SAVE/DELETE REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveReport(){
  const name=document.getElementById('rptName').value.trim();
  if(!name){alert('Inserisci un nome per il report');return;}
  const {type,params}=getReportConfig();
  const typeLabels={estratto:'Estratto Conto',categoria:'Per Categoria',tipo:'Per Tipo',date:'Per Periodo',saldo:'Saldo Entit√†',fx:'Exchange FX'};
  const rpt={name,type,typeLabel:typeLabels[type],params,updatedAt:new Date().toISOString()};
  if(activeReportIdx!==null)savedReports[activeReportIdx]=rpt; else{savedReports.push(rpt);activeReportIdx=savedReports.length-1;}
  await saveToFirebase(); renderSavedReports(); runReport(); alert(`Report "${name}" salvato!`);
}
async function deleteReport(idx){
  if(!confirm(`Eliminare il report "${savedReports[idx].name}"?`))return;
  savedReports.splice(idx,1);
  if(activeReportIdx===idx){activeReportIdx=null;document.getElementById('reportOutput').style.display='none';}
  else if(activeReportIdx>idx)activeReportIdx--;
  await saveToFirebase(); renderSavedReports();
}
function renderSavedReports(){
  const container=document.getElementById('reportSavedList');
  if(!savedReports.length){container.innerHTML='<div class="report-empty-saved">Nessun report salvato</div>';return;}
  const typeBadge={estratto:'rtb-estratto',categoria:'rtb-categoria',tipo:'rtb-tipo',date:'rtb-date',saldo:'rtb-saldo',fx:'rtb-fx'};
  container.innerHTML=savedReports.map((r,i)=>`
    <div class="report-saved-item ${activeReportIdx===i?'active':''}" onclick="loadReport(${i})">
      <div><div class="report-saved-name">${r.name}</div><div class="report-saved-type"><span class="report-type-badge ${typeBadge[r.type]||''}">${r.typeLabel||r.type}</span></div></div>
      <button class="report-del-btn" onclick="event.stopPropagation();deleteReport(${i})">‚úï</button>
    </div>`).join('');
}
function printReport(){ window.print(); }

// ‚îÄ‚îÄ CATEGORIE STAMPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stampaCategorie(){
  const w=window.open('','_blank','width=800,height:600');
  const now=new Date().toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  const totC2=Object.values(c2Map).reduce((s,a)=>s+a.length,0);
  const totC3=Object.values(c3Map).reduce((s,a)=>s+a.length,0);
  let html=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Categorie</title>
  <style>*{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif;}body{background:white;padding:24px;color:#333;}
  h1{font-size:18px;font-weight:900;margin-bottom:4px;}.subtitle{font-size:11px;color:#888;margin-bottom:20px;}
  .c1-block{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:10px;overflow:hidden;}
  .c1-header{background:#9c27b0;color:white;padding:9px 14px;font-size:13px;font-weight:bold;}
  .c2-header{background:#fff3e0;padding:7px 14px 7px 28px;font-size:12px;font-weight:bold;color:#e67e22;border-bottom:1px solid #f5e6d0;}
  .c3-row{padding:5px 14px 5px 52px;font-size:11px;color:#16a085;border-bottom:1px solid #f0faf7;}
  .empty{color:#aaa;font-style:italic;font-size:11px;padding:6px 14px 6px 28px;}
  .summary-box{display:flex;gap:16px;margin-bottom:20px;}.summary-card{background:#f5f5f5;border-radius:8px;padding:10px 18px;text-align:center;}
  .summary-card .num{font-size:22px;font-weight:900;}.summary-card .lbl{font-size:10px;color:#888;}
  .num-c1{color:#9c27b0;}.num-c2{color:#e67e22;}.num-c3{color:#16a085;}
  .footer{margin-top:24px;font-size:10px;color:#aaa;text-align:right;}
  </style></head><body>`;
  html+=`<h1>üè∑Ô∏è Archivio Categorie</h1><div class="subtitle">Stampato il ${now}</div>
  <div class="summary-box">
    <div class="summary-card"><div class="num num-c1">${c1.length}</div><div class="lbl">Cat.1</div></div>
    <div class="summary-card"><div class="num num-c2">${totC2}</div><div class="lbl">Cat.2</div></div>
    <div class="summary-card"><div class="num num-c3">${totC3}</div><div class="lbl">Cat.3</div></div>
  </div>`;
  c1.forEach(cat1=>{
    const subs2=c2Map[cat1]||[];
    html+=`<div class="c1-block"><div class="c1-header">${cat1}</div>`;
    if(!subs2.length){html+=`<div class="empty">Nessuna Cat.2</div>`;}
    else subs2.forEach(cat2=>{
      const subs3=c3Map[c3k(cat1,cat2)]||[];
      html+=`<div class="c2-header">${cat2}</div>`;
      if(!subs3.length)html+=`<div class="empty">Nessuna Cat.3</div>`;
      else subs3.forEach(cat3=>{ html+=`<div class="c3-row">${cat3}</div>`; });
    });
    html+=`</div>`;
  });
  html+=`<div class="footer">IlTuoCaveau ¬∑ ${now}</div><script>window.onload=()=>window.print();<\/script></body></html>`;
  w.document.write(html); w.document.close();
}

// ‚îÄ‚îÄ BACKUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function salvaBackup(){
  const json=JSON.stringify({version:'2.0-multicur',date:new Date().toISOString(),nomi,c1,c2Map,c3Map,rows,savedReports,refCurr},null,2);
  const blob=new Blob([json],{type:'application/json'}),url=URL.createObjectURL(blob),a=document.createElement('a');
  a.href=url; a.download=`caveau_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
}
function stampaPDF(){ window.print(); }

// ‚îÄ‚îÄ GLOBAL EXPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Object.assign(window, {
  goTo, aggiungi, startEdit, saveEdit, cancelEdit, elimina,
  onFromChange, onToChange, onImportoChange, onImportoToChange, onTassoChange,
  addNome, delNome, startEditNome, saveEditNome, cancelEditNome, renderNomiPage,
  addC1, delC1, addC2, delC2, addC3, delC3,
  renderC2Page, renderC3Page, syncC2ForC3, onC1Change, onC2Change, edC1Change,
  setSort, toggleDD, toggleF, clearFilters, clearDate,
  onEntitySelChange, clearEntityFilter, filterByEntity,
  onTipoSelChange, clearTipoFilter, onValutaSelChange, clearValutaFilter,
  toggleFilterPanel, stampaPDF, salvaBackup, stampaCategorie,
  openSettings, closeSettings, closeSettingsOutside, toggleDark, setRefCurr,
  onRptTypeChange, runReport, saveReport, deleteReport, loadReport, newReport, printReport
});
</script>
</body>
</html>
